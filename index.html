    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DarÄ±ca UÄŸur Okulu - GerÃ§ek ZamanlÄ± Duyuru ğŸ“¢</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Standart Windows ArayÃ¼z Stilleri */
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                overflow-x: hidden;
                /* TV EkranÄ± Arka PlanÄ± (JavaScript ile ayarlanacak) */
                background-color: #f0f2f5; 
            }
            
            /* YayÄ±ncÄ± Paneli (Windows Stili) */
            .publisher-body {
                background-color: #E0E0E0; /* Klasik Windows Gri */
                min-height: 100vh; /* KaydÄ±rma olmamasÄ± iÃ§in min-height */
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px 0; /* Ãœstten ve alttan boÅŸluk */
            }
            .window-frame {
                border: 1px solid #606060;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
                background-color: #F0F0F0; /* Pencere iÃ§i gri */
                width: 100%;
            }
            .title-bar {
                background: linear-gradient(to right, #0058D0, #0078D7); /* Windows mavi gradient */
                color: white;
                padding: 4px 10px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }
            /* UÄŸur Logosu Stili */
            .title-bar-logo {
                height: 20px; /* BaÅŸlÄ±k Ã§ubuÄŸu iÃ§in logo boyutu */
                margin-right: 8px;
                filter: brightness(0) invert(1); /* Logoyu beyaz yap */
            }
            .window-content {
                padding: 16px;
            }
            .form-group {
                border: 1px solid #B0B0B0;
                padding: 12px;
                background: #FFFFFF; /* Form alanlarÄ± beyaz */
                height: 100%; /* SÃ¼tunlarÄ±n eÅŸit boyda olmasÄ±nÄ± saÄŸlar */
            }
            .toolbar {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .win-button {
                background: #E1E1E1;
                border: 1px solid #B0B0B0;
                padding: 6px 12px;
                box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                transition: background 0.2s;
                font-size: 0.9rem;
                cursor: pointer;
            }
            .win-button:hover {
                background: #E5F1FB;
                border-color: #0078D7;
            }
            .win-button:active {
                background: #CCE4F7;
                border-color: #005A9E;
            }
            .win-input, .win-select {
                border: 1px solid #707070;
                padding: 6px;
                background: #FFFFFF;
                width: 100%;
            }
            .win-input:focus, .win-select:focus {
                outline: 1px solid #0078D7;
                border-color: #0078D7;
            }
            .status-bar {
                border-top: 1px solid #B0B0B0;
                padding: 4px 8px;
                background: #F5F5F5;
                font-size: 0.8rem;
                color: #404040;
                margin-top: 16px; /* Ä°Ã§erikten sonra */
            }
            
            /* ACÄ°L DURUM BUTONU */
            .emergency-button {
                background: #D9534F;
                color: white;
                border: 1px solid #A94442;
                padding: 10px 16px;
                font-weight: bold;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                margin-bottom: 16px;
            }
            .emergency-button:hover {
                background: #C9302C;
            }
            .emergency-button.armed {
                background: #F0AD4E; /* SarÄ± - Teyit bekleniyor */
                color: #333;
            }

            /* --- AlÄ±cÄ± (TV) Stilleri --- */
            .receiver-desktop {
                height: 100vh;
                width: 100vw;
                /* Arka plan JS ile ayarlanacak */
                background-size: cover;
                background-position: center;
                position: relative;
                overflow: hidden; /* KaydÄ±rmayÄ± engelle */
                padding: 20px;
                display: flex; /* Flexbox dÃ¼zeni iÃ§in */
                gap: 20px; /* Pencereler arasÄ± boÅŸluk */
                transition: background-image 1s ease-in-out; /* YumuÅŸak arka plan geÃ§iÅŸi */
            }
            .draggable-window {
                min-width: 350px;
                min-height: 200px;
                position: absolute; /* SÃ¼rÃ¼kleme iÃ§in */
                display: flex;
                flex-direction: column;
                border-radius: 8px; /* Resmi ama modern */
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                overflow: hidden;
                /* Cam Efekti */
                background: rgba(255, 255, 255, 0.7); /* YarÄ± saydam beyaz */
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.8);
                transition: all 0.5s ease; /* Pozisyon deÄŸiÅŸimi iÃ§in animasyon */
            }
            .window-header {
                padding: 10px 16px;
                cursor: move; /* SÃ¼rÃ¼kleme imleci */
                font-weight: bold;
                background: rgba(255, 255, 255, 0.8);
                border-bottom: 1px solid rgba(200, 200, 200, 0.5);
                /* DEV YAZI */
                font-size: 2.2rem; /* 36px */
                color: #1a202c; /* Koyu renk */
            }
            .window-body {
                padding: 16px;
                flex-grow: 1; /* Esne, alanÄ± doldur */
                overflow: hidden; /* KaydÄ±rma iÃ§in */
                /* DEV YAZI */
                font-size: 2rem; /* 32px */
                line-height: 1.6;
                color: #2d3748; /* Biraz daha aÃ§Ä±k */
            }
            
            /* Otomatik KaydÄ±rma (Marquee) Efekti */
            .scroll-container {
                overflow: hidden;
                height: 100%;
                position: relative;
            }
            .scroll-content {
                position: absolute;
                width: 100%;
                /* Animasyon JS'de tanÄ±mlanacak */
            }
            
            /* Yeni duyuru geldiÄŸinde hafif parlama */
            .window-pulse {
                animation: pulse-yellow 1.5s 1;
            }
            @keyframes pulse-yellow {
                0% { box-shadow: 0 0 0 0px rgba(236, 201, 75, 0.7); }
                70% { box-shadow: 0 0 0 20px rgba(236, 201, 75, 0); }
                100% { box-shadow: 0 0 0 0px rgba(236, 201, 75, 0); }
            }

            /* Hata (Shake) Animasyonu */
            .shake {
                animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            }
            @keyframes shake {
                10%, 90% { transform: translateX(-1px); }
                20%, 80% { transform: translateX(2px); }
                30%, 50%, 70% { transform: translateX(-4px); }
                40%, 60% { transform: translateX(4px); }
            }
            
            /* TV EkranÄ± UÄŸur Logosu (Filigran) */
            .watermark-logo {
                position: absolute;
                bottom: 20px;
                right: 20px;
                height: 60px; /* Filigran boyutu */
                opacity: 0.5; /* YarÄ± saydam */
                pointer-events: none; /* TÄ±klanamaz */
            }
        </style>
    </head>
    <body id="body-container">

        <!-- 1. Rol SeÃ§im EkranÄ± -->
        <div id="role-selection-screen" class="publisher-body">
            <div class="window-frame" style="max-width: 24rem;"> <!-- max-w-sm -->
                <div class="title-bar">
                    <span>DarÄ±ca UÄŸur Okulu Duyuru Sistemi</span>
                </div>
                <div class="window-content text-center">
                    <h1 class="text-xl font-bold mb-4">Cihaz RolÃ¼ SeÃ§in</h1>
                    <p class="text-gray-700 mb-6">Bu cihaz nasÄ±l kullanÄ±lacak?</p>
                    <div class="space-y-3">
                        <button id="select-publisher" class="win-button w-full">
                            ğŸ‘¨â€ğŸ’» YayÄ±ncÄ± (Komuta Merkezi)
                        </button>
                        <button id="select-receiver" class="win-button w-full">
                            ğŸ–¥ï¸ AlÄ±cÄ± (TV EkranÄ±)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Åifre EkranÄ± (YayÄ±ncÄ± iÃ§in) -->
        <div id="password-screen" class="publisher-body hidden">
            <div class="window-frame" style="max-width: 24rem;"> <!-- max-w-sm -->
                <div class="title-bar">
                    <span>GÃ¼venlik DoÄŸrulamasÄ±</span>
                </div>
                <div class="window-content">
                    <label for="password-input" class="block text-sm font-medium text-gray-800 mb-2">YayÄ±ncÄ± Åifresi:</label>
                    <input id="password-input" type="password" class="win-input mb-3" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    <button id="login-button" class="win-button w-full bg-blue-500 text-white hover:bg-blue-600">GiriÅŸ Yap</button>
                    <p id="password-hint" class="text-gray-600 text-xs mt-3">Ä°pucu: ÅŸifre 1234</p>
                    <p id="password-error" class="text-red-600 text-sm mt-2 hidden">HatalÄ± ÅŸifre!</p>
                    <button id="back-to-roles" class="text-gray-600 hover:text-blue-600 text-sm mt-4">&laquo; Geri</button>
                </div>
            </div>
        </div>

        <!-- 3. YayÄ±ncÄ± Ana Uygulama EkranÄ± (KOMUTA MERKEZÄ°) -->
        <div id="publisher-screen" class="publisher-body hidden">
            <!-- GeniÅŸ DikdÃ¶rtgen Panel (max-w-7xl) -->
            <div class="window-frame" style="max-width: 80rem;"> <!-- max-w-7xl -->
                <div class="title-bar">
                    <!-- UÄUR OKULLARI LOGOSU (BAÅLIK Ã‡UBUÄU) -->
                    <div class="flex items-center">
                        <img src="https://www.ugurokullari.k12.tr/assets/images/logo.svg" alt="UÄŸur OkullarÄ± Logosu" class="title-bar-logo">
                        <span>ğŸ‘¨â€ğŸ’» Komuta Merkezi (DarÄ±ca UÄŸur Okulu)</span>
                    </div>
                    <span id="publisher-clock">--:--:--</span>
                </div>
                
                <!-- ACÄ°L DURUM BUTONU -->
                <div id="emergency-button" class="emergency-button">
                    ğŸš¨ ACÄ°L DURUM DUYURUSU YAYINLA ğŸš¨
                </div>

                <!-- Ana Ä°Ã§erik AlanÄ± (3 SÃœTUNLU GRÄ°D) -->
                <div class="window-content grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- SÃœTUN 1: Ana Formlar -->
                    <div class="flex flex-col space-y-4">
                        <!-- Manuel Duyuru Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">1. Manuel Duyuru GÃ¶nder</h2>
                            <label class="block text-sm font-medium text-gray-800">BaÅŸlÄ±k:</label>
                            <input id="title-input" type="text" class="win-input mb-2" placeholder="Ã–rn: Veli ToplantÄ±sÄ±">
                            
                            <label class="block text-sm font-medium text-gray-800">Ã–nem Derecesi:</label>
                            <select id="urgency-select" class="win-select mb-2">
                                <option value="normal">Normal</option>
                                <option value="onemli">Ã–nemli</option>
                                <option value="acil">ğŸš¨ ACÄ°L</option>
                            </select>
                            
                            <label class="block text-sm font-medium text-gray-800">Kime:</label>
                            <select id="audience-select" class="win-select mb-2">
                                <option value="tum-okul">TÃ¼m Okul</option>
                                <option value="ogrenciler">Ã–ÄŸrenciler</option>
                                <option value="ogretmenler">Ã–ÄŸretmenler</option>
                                <option value="veliler">Veliler</option>
                            </select>

                            <label class="block text-sm font-medium text-gray-800">Detay:</label>
                            <textarea id="announcement-input" rows="5" class="win-input mb-2" placeholder="Duyuru ile ilgili detaylar..."></textarea>
                            
                            <button id="publish-button" class="win-button w-full bg-green-600 text-white hover:bg-green-700" disabled>YayÄ±nla ğŸš€</button>
                        </div>
                        
                        <!-- SÄ±nav Takvimi Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">2. SÄ±nav Takvimi GÃ¶nder</h2>
                            <label class="block text-sm font-medium text-gray-800">SÄ±nÄ±f (Ã–rn: 9-A):</label>
                            <input id="exam-class" type="text" class="win-input mb-2">
                            <label class="block text-sm font-medium text-gray-800">Ders:</label>
                            <input id="exam-subject" type="text" class="win-input mb-2" placeholder="Ã–rn: Matematik">
                            <label class="block text-sm font-medium text-gray-800">Tarih ve Saat:</label>
                            <input id="exam-date" type="text" class="win-input mb-2" placeholder="Ã–rn: 15 KasÄ±m Cuma, 10:00">
                            <button id="publish-exam-button" class="win-button w-full">SÄ±nav Duyurusu YayÄ±nla ğŸ“…</button>
                        </div>
                    </div>

                    <!-- SÃœTUN 2: HÄ±zlÄ± AraÃ§lar ve Bilgiler -->
                    <div class="flex flex-col space-y-4">
                        <!-- Ekran DÃ¼zeni KontrolÃ¼ -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ–¥ï¸ TV Ekran DÃ¼zeni</h2>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="layout-btn win-button" data-layout="left-right">Sol/SaÄŸ (VarsayÄ±lan)</button>
                                <button class="layout-btn win-button" data-layout="full-announcement">Tam Ekran (Duyuru)</button>
                                <button class="layout-btn win-button" data-layout="full-info">Tam Ekran (Bilgi)</button>
                                <button class="layout-btn win-button" data-layout="top-bottom">Ãœst/Alt</button>
                            </div>
                        </div>
                        
                        <!-- AnlÄ±k Ä°Ã§erik -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ’¡ AnlÄ±k Ä°Ã§erik GÃ¶nder</h2>
                            <div class="space-y-2">
                                <button id="gen-fun-fact" class="win-button w-full">ğŸ§  EÄŸlenceli Bilgi Ver</button>
                                <button id="gen-quote" class="win-button w-full">ğŸ’¡ GÃ¼nÃ¼n SÃ¶zÃ¼</button>
                                <button id="gen-word" class="win-button w-full">ğŸ‡¬ğŸ‡§ GÃ¼nÃ¼n Ä°ng. Kelimesi</button>
                                <button id="send-bell-times" class="win-button w-full">ğŸ”” Zil Saatlerini GÃ¶nder</button>
                                <button id="gen-today-history" class="win-button w-full">ğŸ“œ Tarihte BugÃ¼n</button>
                            </div>
                        </div>

                        <!-- HÄ±zlÄ± Åablonlar (Buraya TaÅŸÄ±ndÄ±) -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">âš¡ HÄ±zlÄ± Åablonlar</h2>
                            <div class="toolbar">
                                <button data-template="menu" class="template-btn win-button">ğŸ½ï¸ MenÃ¼</button>
                                <button data-template="tost" class="template-btn win-button">ğŸ‰ Tost</button>
                                <button data-template="club" class="template-btn win-button">ğŸ­ KulÃ¼p</button>
                                <button data-template="poll" class="template-btn win-button">ğŸ“Š Anket</button>
                                <button data-template="book" class="template-btn win-button">ğŸ“š Kitap Ã–ner</button>
                                <button data-template="stock" class="template-btn win-button">ğŸ¥ª Stok Bitti</button>
                            </div>
                        </div>
                    </div>

                    <!-- SÃœTUN 3: Yeni AraÃ§lar ve Åablonlar -->
                    <div class="flex flex-col space-y-4">
                        <!-- NÃ¶betÃ§i Bilgisi Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ‘¨â€ğŸ« NÃ¶betÃ§i Bilgisi</h2>
                            <label class="block text-sm font-medium text-gray-800">NÃ¶betÃ§i Ã–ÄŸretmen:</label>
                            <input id="teacher-duty" type="text" class="win-input mb-2" placeholder="Ã–rn: Ahmet YÄ±lmaz">
                            <label class="block text-sm font-medium text-gray-800">NÃ¶betÃ§i Ã–ÄŸrenci:</label>
                            <input id="student-duty" type="text" class="win-input mb-2" placeholder="Ã–rn: Zeynep Kaya (11-B)">
                            <button id="publish-duty-button" class="win-button w-full">NÃ¶betÃ§i Bilgisi YayÄ±nla</button>
                        </div>

                        <!-- HaftanÄ±n Ã–ÄŸrencisi Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ† HaftanÄ±n Ã–ÄŸrencisi GÃ¶nder</h2>
                            <label class="block text-sm font-medium text-gray-800">Ã–ÄŸrenci AdÄ± ve SÄ±nÄ±fÄ±:</label>
                            <input id="star-student-name" type="text" class="win-input mb-2" placeholder="Ã–rn: Zeynep YÄ±lmaz (5-B)">
                            <label class="block text-sm font-medium text-gray-800">Neden (KÄ±sa):</label>
                            <input id="star-student-reason" type="text" class="win-input mb-2" placeholder="Ã–rn: Bilim fuarÄ±ndaki baÅŸarÄ±sÄ±">
                            <button id="publish-star-student" class="win-button w-full">HaftanÄ±n Ã–ÄŸrencisi YayÄ±nla</button>
                        </div>
                        
                        <!-- DoÄŸum GÃ¼nÃ¼ Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ‚ DoÄŸum GÃ¼nÃ¼ Kutla</h2>
                            <label class="block text-sm font-medium text-gray-800">Ã–ÄŸrenci AdÄ± ve SÄ±nÄ±fÄ±:</label>
                            <input id="birthday-name" type="text" class="win-input mb-2" placeholder="Ã–rn: Elif Kaya (2-A)">
                            <button id="publish-birthday" class="win-button w-full">DoÄŸum GÃ¼nÃ¼ YayÄ±nla ğŸ‰</button>
                        </div>
                        
                        <!-- YENÄ°: Servis Bilgisi Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸšŒ Servis Bilgisi GÃ¶nder</h2>
                            <label class="block text-sm font-medium text-gray-800">Servis No / GÃ¼zergah:</label>
                            <input id="service-route" type="text" class="win-input mb-2" placeholder="Ã–rn: 34 ABC 123 / Gebze">
                            <label class="block text-sm font-medium text-gray-800">Mesaj:</label>
                            <input id="service-message" type="text" class="win-input mb-2" placeholder="Ã–rn: 10 dakika gecikecektir.">
                            <button id="publish-service" class="win-button w-full">Servis Bilgisi YayÄ±nla</button>
                        </div>
                        
                        <!-- YENÄ°: KayÄ±p EÅŸya Formu -->
                        <div class="form-group">
                            <h2 class="font-bold text-lg mb-2 text-blue-700">ğŸ’ KayÄ±p EÅŸya Bildir</h2>
                            <label class="block text-sm font-medium text-gray-800">Bulunan EÅŸya:</label>
                            <input id="lost-item" type="text" class="win-input mb-2" placeholder="Ã–rn: Mavi Mont">
                            <label class="block text-sm font-medium text-gray-800">BulunduÄŸu Yer:</label>
                            <input id="lost-location" type="text" class="win-input mb-2" placeholder="Ã–rn: Spor Salonu">
                            <button id="publish-lost-item" class="win-button w-full">KayÄ±p EÅŸya YayÄ±nla</button>
                        </div>
                    </div>

                </div>
                <div class="status-bar">
                    <span>Durum: Firebase'e baÄŸlÄ±.</span>
                </div>
            </div>
        </div>

        <!-- 4. AlÄ±cÄ± Ana Uygulama EkranÄ± (TV MasaÃ¼stÃ¼) -->
        <div id="receiver-screen" class="receiver-desktop hidden">
            <!-- UÄUR OKULLARI LOGOSU (FÄ°LÄ°GRAN) -->
            <img src="https://www.ugurokullari.k12.tr/assets/images/logo.svg" alt="UÄŸur OkullarÄ± Logosu" class="watermark-logo">
            
            <!-- Pencereler JavaScript tarafÄ±ndan buraya eklenecek -->
        </div>

        <!-- TV PENCERE ÅABLONLARI -->
        <template id="window-template">
            <div class="draggable-window">
                <div class="window-header"></div>
                <div class="window-body">
                    <div class="scroll-container">
                        <div class="scroll-content">
                            <!-- Ä°Ã§erik buraya gelecek -->
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <script type="module">
            // Firebase modÃ¼llerini import et
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // === KODUN TAMAMI DOM YÃœKLENDÄ°KTEN SONRA Ã‡ALIÅACAK ===
            document.addEventListener('DOMContentLoaded', () => {
                
                // --- Firebase YapÄ±landÄ±rmasÄ± (Kritik) ---
                const firebaseConfig = {
                    apiKey: "AIzaSyBeQsh4Tp-YbLG8BcgoMDKXi5gJ0rBZ5pI",
                    authDomain: "emirokuldeneme.firebaseapp.com",
                    projectId: "emirokuldeneme",
                    storageBucket: "emirokuldeneme.firebasestorage.app",
                    messagingSenderId: "821824749207",
                    appId: "1:821824749207:web:164b0ea4c79bf9636f33d2"
                };
                
                // --- Gemini AI YapÄ±landÄ±rmasÄ± ---
                const GEMINI_API_KEY = "AIzaSyBx84HfcrsNwfEjK5kd-yGqrFC4nr_uDjc"; // KullanÄ±cÄ±nÄ±n verdiÄŸi anahtar
                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                // --- YENÄ°: TV Arka Plan FotoÄŸraflarÄ± ---
                const backgroundImages = [
                    'https://images.unsplash.com/photo-1509062522246-3755977927d7?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDR8fGNsYXNzcm9vbXxlbnwwfHx8fDE3MzEwMDQ0MDV8MA&ixlib=rb-4.0.3&q=80&w=1080', // SÄ±nÄ±f sÄ±rasÄ±
                    'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDJ8fHNjaG9vbCUyMGNhbXB1c3xlbnwwfHx8fDE3MzEwMDQ0MjF8MA&ixlib=rb-4.0.3&q=80&w=1080', // KampÃ¼s
                    'https://images.unsplash.com/photo-1543269865-cbf427effbad?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDEwfHxzdHVkZW50c3xlbnwwfHx8fDE3MzEwMDQ0MzN8MA&ixlib=rb-4.0.3&q=80&w=1080', // GÃ¼len Ã¶ÄŸrenciler
                    'https://images.unsplash.com/photo-1497633762265-9d179a990aaa?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDEwfHxsaWJyYXJ5fGVufDB8fHx8fDE3MzEwMDQ0NDN8MA&ixlib=rb-4.0.3&q=80&w=1080', // KÃ¼tÃ¼phane
                    'https://images.unsplash.com/photo-1577896851231-70ef1888175b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDEyfHxzY2hvb2x8ZW58MHx8fHwxNzMxMDA0NDUwfDA&ixlib=rb-4.0.3&q=80&w=1080', // Defterler
                    'https://images.unsplash.com/photo-1588075592446-265fd1e6e76f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDE4fHxzY2hvb2wlMjBidXN8ZW58MHx8fHwxNzMxMDA0NDYyfDA&ixlib=rb-4.0.3&q=80&w=1080', // Okul otobÃ¼sÃ¼
                    'https://images.unsplash.com/photo-1546410531-bb4ac68a598c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDExfHxlZHVjYXRpb258ZW58MHx8fHwxNzMxMDA0NDcxfDA&ixlib=rb-4.0.3&q=80&w=1080', // Kep atma
                    'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDF8fGxpYnJhcnl8ZW58MHx8fHwxNzMxMDA0NDQzfDA&ixlib=rb-4.0.3&q=80&w=1080', // KitaplÄ±k
                    'https://images.unsplash.com/photo-1517048676732-d65bc937f952?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDl8fHdvcmtzaG9wfGVufDB8fHx8fDE3MzEwMDQ0OTV8MA&ixlib=rb-4.0.3&q=80&w=1080', // AtÃ¶lye
                    'https://images.unsplash.com/photo-1453928582365-b6ad33cb1211?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjUyOXwwfDF8c2VhcmNofDh8fGFydCUyMGNsYXNzfGVufDB8fHx8fDE3MzEwMDQ1MTl8MA&ixlib=rb-4.0.3&q=80&w=1080' // Sanat sÄ±nÄ±fÄ±
                ];

                // --- Firebase DeÄŸiÅŸkenleri ---
                let db, auth, userId;
                const appId = firebaseConfig.projectId || 'genel-duyuru-odasi';
                
                // Firebase Hizmetlerini BaÅŸlat
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('Debug'); // Hata ayÄ±klama iÃ§in
                    console.log("Firebase baÅŸarÄ±yla baÅŸlatÄ±ldÄ±.");
                } catch (error) {
                    console.error("Firebase baÅŸlatma hatasÄ±:", error);
                    alert("Kritik Hata: Firebase baÅŸlatÄ±lamadÄ±. LÃ¼tfen konsolu kontrol edin.");
                    return; // Kodun geri kalanÄ± Ã§alÄ±ÅŸmasÄ±n
                }

                // --- Firestore Belge YollarÄ± ---
                const docPaths = {
                    announcement: doc(db, 'artifacts', appId, 'public/data', 'announcements', 'latest'),
                    info: doc(db, 'artifacts', appId, 'public/data', 'info', 'latest'),
                    layout: doc(db, 'artifacts', appId, 'public/data', 'layout', 'latest')
                };

                // --- DOM Elementleri ---
                const bodyContainer = document.getElementById('body-container');
                // Ekranlar
                const roleScreen = document.getElementById('role-selection-screen');
                const passwordScreen = document.getElementById('password-screen');
                const publisherScreen = document.getElementById('publisher-screen');
                const receiverScreen = document.getElementById('receiver-screen');
                
                // Rol SeÃ§imi
                const selectPublisherBtn = document.getElementById('select-publisher');
                const selectReceiverBtn = document.getElementById('select-receiver');
                
                // Åifre EkranÄ±
                const passwordInput = document.getElementById('password-input');
                const loginButton = document.getElementById('login-button');
                const passwordError = document.getElementById('password-error');
                const backToRolesBtn = document.getElementById('back-to-roles');
                const publisherClock = document.getElementById('publisher-clock');
                
                // YayÄ±ncÄ± Kontrolleri (TÃ¼mÃ¼)
                const titleInput = document.getElementById('title-input');
                const urgencySelect = document.getElementById('urgency-select');
                const audienceSelect = document.getElementById('audience-select');
                const inputArea = document.getElementById('announcement-input');
                const publishButton = document.getElementById('publish-button');
                const genFunFactBtn = document.getElementById('gen-fun-fact');
                const genQuoteBtn = document.getElementById('gen-quote');
                const genWordBtn = document.getElementById('gen-word');
                const emergencyButton = document.getElementById('emergency-button');
                const teacherDutyInput = document.getElementById('teacher-duty');
                const studentDutyInput = document.getElementById('student-duty');
                const publishDutyButton = document.getElementById('publish-duty-button');
                const sendBellTimesBtn = document.getElementById('send-bell-times');
                const examClassInput = document.getElementById('exam-class');
                const examSubjectInput = document.getElementById('exam-subject');
                const examDateInput = document.getElementById('exam-date');
                const publishExamButton = document.getElementById('publish-exam-button');
                const starStudentNameInput = document.getElementById('star-student-name');
                const starStudentReasonInput = document.getElementById('star-student-reason');
                const publishStarStudentBtn = document.getElementById('publish-star-student');
                const genTodayHistoryBtn = document.getElementById('gen-today-history');
                const birthdayNameInput = document.getElementById('birthday-name');
                const publishBirthdayBtn = document.getElementById('publish-birthday');
                
                // YENÄ° DOM Elementleri (Servis, KayÄ±p EÅŸya)
                const serviceRouteInput = document.getElementById('service-route');
                const serviceMessageInput = document.getElementById('service-message');
                const publishServiceBtn = document.getElementById('publish-service');
                const lostItemInput = document.getElementById('lost-item');
                const lostLocationInput = document.getElementById('lost-location');
                const publishLostItemBtn = document.getElementById('publish-lost-item');


                // --- Saat ---
                function updateClock() {
                    if (publisherClock && publisherClock.offsetParent) { // BulunduÄŸundan emin ol
                        publisherClock.textContent = new Date().toLocaleTimeString('tr-TR');
                    }
                }
                setInterval(updateClock, 1000);

                // --- Rol SeÃ§im OlaylarÄ± ---
                if (selectPublisherBtn) {
                    selectPublisherBtn.addEventListener('click', () => {
                        roleScreen.classList.add('hidden');
                        passwordScreen.classList.remove('hidden');
                        passwordInput.focus();
                    });
                }

                if (selectReceiverBtn) {
                    selectReceiverBtn.addEventListener('click', () => {
                        startAppAs('receiver');
                    });
                }

                if (backToRolesBtn) {
                    backToRolesBtn.addEventListener('click', () => {
                        passwordScreen.classList.add('hidden');
                        roleScreen.classList.remove('hidden');
                        passwordError.classList.add('hidden');
                        passwordInput.value = "";
                    });
                }

                // --- Åifre KontrolÃ¼ ---
                function handleLogin() {
                    if (passwordInput.value === "1234") {
                        passwordScreen.classList.add('hidden');
                        passwordInput.value = "";
                        passwordError.classList.add('hidden');
                        startAppAs('publisher'); // Åifre doÄŸru
                    } else {
                        passwordError.classList.remove('hidden');
                        passwordScreen.classList.add('shake');
                        setTimeout(() => passwordScreen.classList.remove('shake'), 500);
                    }
                }
                if (loginButton) loginButton.addEventListener('click', handleLogin);
                if (passwordInput) passwordInput.addEventListener('keyup', (e) => (e.key === 'Enter') && handleLogin());


                // --- Uygulama BaÅŸlatma ---
                function startAppAs(role) {
                    roleScreen.classList.add('hidden');
                    
                    if (role === 'publisher') {
                        bodyContainer.className = 'publisher-body';
                        publisherScreen.classList.remove('hidden');
                        setupAuth(role); // YayÄ±ncÄ± iÃ§in kimlik doÄŸrulama
                    } else {
                        // YENÄ°: Rastgele arka plan seÃ§
                        const randomBg = backgroundImages[Math.floor(Math.random() * backgroundImages.length)];
                        receiverScreen.style.backgroundImage = `url('${randomBg}')`;
                        
                        bodyContainer.className = 'receiver-desktop'; // TV arkaplanÄ±
                        receiverScreen.classList.remove('hidden');
                        setupAuth(role); // AlÄ±cÄ± iÃ§in kimlik doÄŸrulama
                    }
                }
                
                // --- Firebase Kimlik DoÄŸrulama ---
                async function setupAuth(role) {
                    try {
                        await signInAnonymously(auth);
                        console.log("Kimlik doÄŸrulandÄ± (Anonim).");
                        
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log("KullanÄ±cÄ± ID:", userId);
                                // Rol'e gÃ¶re dinleyicileri veya kontrolleri kur
                                if (role === 'publisher') {
                                    setupPublisherControls();
                                } else {
                                    setupReceiverListeners();
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Anonim giriÅŸ hatasÄ±:", error);
                        alert("Hata: Kimlik doÄŸrulanamadÄ±.");
                    }
                }

                // --- YAYINCI (PUBLISHER) BÃ–LÃœMÃœ ---
                function setupPublisherControls() {
                    publishButton.disabled = false;
                    publishButton.addEventListener('click', publishAnnouncement);
                    
                    // AnlÄ±k Ä°Ã§erik ButonlarÄ±
                    genFunFactBtn.addEventListener('click', () => generateGeminiContent('fun-fact'));
                    genQuoteBtn.addEventListener('click', () => generateGeminiContent('quote'));
                    genWordBtn.addEventListener('click', () => generateGeminiContent('word'));
                    genTodayHistoryBtn.addEventListener('click', () => generateGeminiContent('today-in-history'));
                    
                    // Acil Durum Butonu
                    emergencyButton.addEventListener('click', handleEmergencyClick);
                    
                    // NÃ¶betÃ§i Butonu
                    publishDutyButton.addEventListener('click', publishDutyInfo);

                    // Zil Saatleri
                    sendBellTimesBtn.addEventListener('click', publishBellTimes);

                    // SÄ±nav Takvimi
                    publishExamButton.addEventListener('click', publishExamSchedule);
                    
                    // HaftanÄ±n Ã–ÄŸrencisi
                    publishStarStudentBtn.addEventListener('click', publishStarStudent);
                    
                    // DoÄŸum GÃ¼nÃ¼
                    publishBirthdayBtn.addEventListener('click', publishBirthday);
                    
                    // YENÄ°: Servis ve KayÄ±p EÅŸya
                    publishServiceBtn.addEventListener('click', publishServiceInfo);
                    publishLostItemBtn.addEventListener('click', publishLostItemInfo);

                    // DÃ¼zen ButonlarÄ±
                    document.querySelectorAll('.layout-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => publishLayout(e.target.dataset.layout));
                    });
                    
                    // Åablon ButonlarÄ±
                    setupTemplateButtons();
                }
                
                // Genel YayÄ±n Fonksiyonu
                async function publishToDoc(docRef, data, successMsg) {
                    try {
                        // `merge: true` yerine tam belgeyi yazÄ±yoruz
                        await setDoc(docRef, data); 
                        console.log(successMsg);
                    } catch (error) {
                        console.error("YayÄ±nlama hatasÄ±:", error);
                        alert(`Hata: ${successMsg} gÃ¶nderilemedi.`);
                    }
                }

                // 1. Manuel Duyuru YayÄ±nla
                function publishAnnouncement() {
                    const title = titleInput.value.trim();
                    const text = inputArea.value.trim();
                    if (!title || !text) return alert("BaÅŸlÄ±k ve Detay boÅŸ olamaz.");

                    publishToDoc(docPaths.announcement, {
                        title: title,
                        text: text,
                        urgency: urgencySelect.value,
                        audience: audienceSelect.value,
                        timestamp: new Date().toISOString()
                    }, "Manuel duyuru yayÄ±nlandÄ±");
                    
                    // Formu temizle
                    titleInput.value = ""; inputArea.value = "";
                    urgencySelect.value = "normal"; audienceSelect.value = "tum-okul";
                }
                
                // 2. Acil Durum YÃ¶netimi
                let emergencyClickCount = 0;
                function handleEmergencyClick() {
                    emergencyClickCount++;
                    if (emergencyClickCount === 1) {
                        emergencyButton.textContent = "EMÄ°N MÄ°SÄ°N? TEYÄ°T Ä°Ã‡Ä°N TEKRAR TIKLA!";
                        emergencyButton.classList.add('armed');
                        setTimeout(() => {
                            emergencyButton.textContent = "ğŸš¨ ACÄ°L DURUM DUYURUSU YAYINLA ğŸš¨";
                            emergencyButton.classList.remove('armed');
                            emergencyClickCount = 0;
                        }, 3000); 
                    } else if (emergencyClickCount === 2) {
                        // Ã–nce dÃ¼zeni ayarla
                        publishLayout('full-announcement');
                        // Sonra acil durum mesajÄ±nÄ± gÃ¶nder
                        publishToDoc(docPaths.announcement, {
                            title: "ğŸš¨ ACÄ°L DURUM ğŸš¨",
                            text: "LÃ¼tfen sakin olun ve Ã¶ÄŸretmenlerinizin yÃ¶nlendirmelerine uyun.\nEn yakÄ±n Ã§Ä±kÄ±ÅŸa doÄŸru sakince ilerleyin.",
                            urgency: "acil",
                            audience: "tum-okul",
                            timestamp: new Date().toISOString()
                        }, "ACÄ°L DURUM MESAJI GÃ–NDERÄ°LDÄ°");
                        
                        emergencyButton.textContent = "ğŸš¨ ACÄ°L DURUM DUYURUSU YAYINLA ğŸš¨";
                        emergencyButton.classList.remove('armed');
                        emergencyClickCount = 0;
                    }
                }

                // 3. SÄ±nav Takvimi YayÄ±nla
                function publishExamSchedule() {
                    const sinif = examClassInput.value.trim();
                    const ders = examSubjectInput.value.trim();
                    const tarih = examDateInput.value.trim();
                    if (!sinif || !ders || !tarih) return alert("SÄ±nav bilgileri eksik.");
                    
                    publishToDoc(docPaths.announcement, {
                        title: `ğŸ“… SÄ±nav Duyurusu (${sinif})`,
                        text: `Ders: ${ders}\nTarih: ${tarih}\n\nTÃ¼m Ã¶ÄŸrencilerimize baÅŸarÄ±lar dileriz.`,
                        urgency: "onemli",
                        audience: sinif, // 'Kime' alanÄ± sÄ±nÄ±f olarak ayarlandÄ±
                        timestamp: new Date().toISOString()
                    }, "SÄ±nav takvimi yayÄ±nlandÄ±");
                    examClassInput.value = ""; examSubjectInput.value = ""; examDateInput.value = "";
                }
                
                // YENÄ°: Servis Bilgisi YayÄ±nla (Duyuru olarak gider)
                function publishServiceInfo() {
                    const route = serviceRouteInput.value.trim();
                    const message = serviceMessageInput.value.trim();
                    if (!route || !message) return alert("Servis bilgileri eksik.");
                    
                    publishToDoc(docPaths.announcement, {
                        title: `ğŸšŒ Servis Bilgisi (${route})`,
                        text: message,
                        urgency: "onemli", // Servis bilgisi Ã¶nemlidir
                        audience: "veliler", // Genelde veli ve Ã¶ÄŸrencileri ilgilendirir
                        timestamp: new Date().toISOString()
                    }, "Servis bilgisi yayÄ±nlandÄ±");
                    serviceRouteInput.value = ""; serviceMessageInput.value = "";
                }


                // 4. Bilgi Penceresi Ä°Ã§erikleri (NÃ¶betÃ§i, Zil, AI, YENÄ°LER)
                function publishInfo(title, content) {
                    publishToDoc(docPaths.info, {
                        title: title,
                        text: content,
                        timestamp: new Date().toISOString()
                    }, `Bilgi yayÄ±nlandÄ±: ${title}`);
                }

                // YENÄ°: KayÄ±p EÅŸya YayÄ±nla (Bilgi olarak gider)
                function publishLostItemInfo() {
                    const item = lostItemInput.value.trim();
                    const location = lostLocationInput.value.trim();
                    if (!item || !location) return alert("KayÄ±p eÅŸya bilgileri eksik.");
                    
                    const content = `Bulunan EÅŸya: ${item}\nBulunduÄŸu Yer: ${location}\n\nÄ°lgili kiÅŸilerin MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± ile iletiÅŸime geÃ§mesi rica olunur.`;
                    publishInfo("ğŸ’ KayÄ±p EÅŸya", content);
                    
                    lostItemInput.value = ""; lostLocationInput.value = "";
                }

                function publishBirthday() {
                    const name = birthdayNameInput.value.trim();
                    if (!name) return alert("DoÄŸum gÃ¼nÃ¼ olanÄ±n adÄ± eksik.");
                    const content = `${name}\n\nÄ°yi ki doÄŸdun, harika bir yÄ±l geÃ§irmeni dileriz! ğŸ¥³`;
                    publishInfo("ğŸ‰ Mutlu YÄ±llar!", content);
                    birthdayNameInput.value = "";
                }

                function publishStarStudent() {
                    const name = starStudentNameInput.value.trim();
                    const reason = starStudentReasonInput.value.trim();
                    if (!name || !reason) return alert("HaftanÄ±n Ã¶ÄŸrencisi bilgileri eksik.");
                    
                    const content = `Ã–ÄŸrenci: ${name}\nSebep: ${reason}\n\nTebrik ederiz! ğŸ‘`;
                    publishInfo("ğŸ† HaftanÄ±n Ã–ÄŸrencisi", content);
                    
                    starStudentNameInput.value = "";
                    starStudentReasonInput.value = "";
                }

                function publishDutyInfo() {
                    const teacher = teacherDutyInput.value.trim();
                    const student = studentDutyInput.value.trim();
                    if (!teacher && !student) return alert("NÃ¶betÃ§i bilgisi boÅŸ.");
                    
                    let content = "";
                    if (teacher) content += `Ã–ÄŸretmen: ${teacher}\n`;
                    if (student) content += `Ã–ÄŸrenci: ${student}`;
                    
                    publishInfo("ğŸ‘¨â€ğŸ« GÃ¼nÃ¼n NÃ¶betÃ§ileri", content);
                    teacherDutyInput.value = "";
                    studentDutyInput.value = "";
                }

                function publishBellTimes() {
                    const content = `09:00 - 09:40 | 1. Ders\n09:50 - 10:30 | 2. Ders\n10:40 - 11:20 | 3. Ders\n11:20 - 12:00 | Ã–ÄLE ARASI\n12:00 - 12:40 | 4. Ders\n12:50 - 13:30 | 5. Ders`;
                    publishInfo("ğŸ”” Zil Saatleri", content);
                }

                // 5. Ekran DÃ¼zenini YayÄ±nla
                function publishLayout(layoutType) {
                    publishToDoc(docPaths.layout, {
                        type: layoutType,
                        timestamp: new Date().toISOString()
                    }, `Ekran dÃ¼zeni "${layoutType}" olarak ayarlandÄ±.`);
                }

                // 6. Gemini AI Ä°Ã§erik Ãœretimi
                async function generateGeminiContent(type) {
                    let prompt, title;
                    switch (type) {
                        case 'fun-fact':
                            prompt = "Bana okul Ã§aÄŸÄ±ndaki Ã§ocuklar iÃ§in ÅŸaÅŸÄ±rtÄ±cÄ± ve eÄŸlenceli bilimsel bir bilgi ver. (KÄ±sa olsun)";
                            title = "ğŸ§  EÄŸlenceli Bilgi";
                            break;
                        case 'quote':
                            prompt = "Bana Ã¶ÄŸrenciler iÃ§in motivasyonel ve kÄ±sa bir gÃ¼nÃ¼n sÃ¶zÃ¼ ver. (Kim sÃ¶ylediÄŸini de belirt)";
                            title = "ğŸ’¡ GÃ¼nÃ¼n SÃ¶zÃ¼";
                            break;
                        case 'word':
                            prompt = "Bana Ã¶ÄŸrenciler iÃ§in bir 'gÃ¼nÃ¼n Ä°ngilizce kelimesi' ver. Kelime, TÃ¼rkÃ§e anlamÄ± ve basit bir Ã¶rnek cÃ¼mle (Ä°ngilizce ve TÃ¼rkÃ§e) saÄŸla. JSON formatÄ±nda ver: {\"word\": \"\", \"meaning\": \"\", \"example_en\": \"\", \"example_tr\": \"\"}";
                            title = "ğŸ‡¬ğŸ‡§ GÃ¼nÃ¼n Ä°ng. Kelimesi";
                            break;
                        case 'today-in-history':
                            prompt = "Bana 'Tarihte BugÃ¼n' iÃ§in okul Ã¶ÄŸrencilerine uygun (bilim, sanat veya keÅŸif aÄŸÄ±rlÄ±klÄ±) Ã¶nemli bir olayÄ± kÄ±saca anlat.";
                            title = "ğŸ“œ Tarihte BugÃ¼n";
                            break;
                    }
                    
                    const btn = document.getElementById(`gen-${type.replace('_','-')}`);
                    try {
                        if (btn) btn.disabled = true;

                        const response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: type === 'word' ? { responseMimeType: "application/json" } : {}
                            })
                        });
                        
                        if (!response.ok) throw new Error(`API hatasÄ±: ${response.statusText}`);
                        
                        const result = await response.json();
                        if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                            throw new Error("API'den geÃ§erli bir yanÄ±t alÄ±namadÄ±.");
                        }
                        const text = result.candidates[0].content.parts[0].text;
                        
                        let content;
                        if (type === 'word') {
                            try {
                                const json = JSON.parse(text);
                                content = `Kelime: ${json.word}\nAnlamÄ±: ${json.meaning}\n\nÃ–rnek:\n${json.example_en}\n(${json.example_tr})`;
                            } catch (e) {
                                console.error("Gemini JSON parse hatasÄ±:", e);
                                content = "Ä°ngilizce kelime formatÄ± alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.";
                            }
                        } else {
                            content = text;
                        }
                        
                        publishInfo(title, content);
                        
                    } catch (error) {
                        console.error("Gemini AI hatasÄ±:", error);
                        alert("Hata: AI iÃ§eriÄŸi Ã¼retilemedi. API anahtarÄ±nÄ± veya baÄŸlantÄ±yÄ± kontrol edin.");
                    } finally {
                        if (btn) btn.disabled = false;
                    }
                }
                
                // 7. HÄ±zlÄ± Åablonlar (GÃœNCELLENDÄ°)
                function setupTemplateButtons() {
                    document.querySelectorAll('.template-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const template = e.target.dataset.template;
                            urgencySelect.value = 'normal';
                            audienceSelect.value = 'tum-okul';
                            
                            switch(template) {
                                case 'menu':
                                    titleInput.value = "ğŸ½ï¸ GÃ¼nÃ¼n MenÃ¼sÃ¼";
                                    inputArea.value = "Afiyet olsun! BugÃ¼nÃ¼n menÃ¼sÃ¼:\n1. ...\n2. ...\n3. ...";
                                    audienceSelect.value = 'ogrenciler';
                                    break;
                                case 'tost':
                                    titleInput.value = "ğŸ‰ Kantin SÃ¼rprizi!";
                                    inputArea.value = "BugÃ¼n kantinde Ã¶zel tost gÃ¼nÃ¼! KaÃ§Ä±rmayÄ±n!";
                                    urgencySelect.value = 'onemli';
                                    audienceSelect.value = 'ogrenciler';
                                    break;
                                // KayÄ±p EÅŸya buradan kaldÄ±rÄ±ldÄ± (forma taÅŸÄ±ndÄ±)
                                case 'club':
                                    titleInput.value = "ğŸ­ KulÃ¼p/Etkinlik Duyurusu";
                                    inputArea.value = "KulÃ¼p AdÄ±: ...\nToplantÄ± Yeri: ...\nToplantÄ± Tarihi: ...\n\nHerkes davetlidir!";
                                    urgencySelect.value = 'onemli';
                                    break;
                                case 'poll':
                                    titleInput.value = "ğŸ“Š Anket: [Soru]";
                                    inputArea.value = "[Soruyu buraya yazÄ±n]\n\nSeÃ§enekler:\n- Evet\n- HayÄ±r\n\n(Oylama [yer] yapÄ±lacaktÄ±r)";
                                    urgencySelect.value = 'onemli';
                                    break;
                                case 'stock':
                                    titleInput.value = "ğŸ¥ª Kantin Bilgisi";
                                    inputArea.value = "[ÃœrÃ¼n AdÄ±] (Ã–rn: Tost) tÃ¼kenmiÅŸtir. AnlayÄ±ÅŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler.";
                                    urgencySelect.value = 'onemli';
                                    audienceSelect.value = 'ogrenciler';
                                    break;
                                case 'book':
                                    titleInput.value = "ğŸ“š HaftanÄ±n Kitap Ã–nerisi";
                                    inputArea.value = "Kitap: [Kitap AdÄ±]\nYazar: [Yazar AdÄ±]\n\nÄ°yi okumalar dileriz!";
                                    urgencySelect.value = 'normal';
                                    break;
                            }
                            titleInput.focus();
                        });
                    });
                }


                // --- ALICI (RECEIVER) BÃ–LÃœMÃœ ---
                let windows = {}; 
                let marqueeAnimations = []; 

                function setupReceiverListeners() {
                    // Pencereleri oluÅŸtur
                    windows.announcement = createDraggableWindow('announcement', 'ğŸ“¢ Duyuru Panosu');
                    windows.info = createDraggableWindow('info', 'ğŸ’¡ GÃ¼nÃ¼n Bilgisi');
                    
                    // BaÅŸlangÄ±Ã§ dÃ¼zenini uygula
                    applyLayout('left-right'); 
                    
                    // Dinleyicileri baÅŸlat
                    onSnapshot(docPaths.announcement, (doc) => updateWindow('announcement', doc, true));
                    onSnapshot(docPaths.info, (doc) => updateWindow('info', doc, true));
                    onSnapshot(docPaths.layout, (doc) => {
                        if (doc.exists()) applyLayout(doc.data().type);
                    });
                }

                function createDraggableWindow(id, title) {
                    const template = document.getElementById('window-template');
                    if (!template) {
                        console.error("Pencere ÅŸablonu bulunamadÄ±!");
                        return null;
                    }
                    const newWindow = template.content.cloneNode(true).firstElementChild;
                    newWindow.id = `window-${id}`;
                    newWindow.querySelector('.window-header').textContent = title;
                    receiverScreen.appendChild(newWindow);
                    
                    makeDraggable(newWindow);
                    return newWindow;
                }

                function updateWindow(id, doc, pulseEffect = false) {
                    const win = windows[id];
                    if (!win) {
                        console.warn(`Pencere "${id}" bulunamadÄ±.`);
                        return;
                    }
                    
                    const header = win.querySelector('.window-header');
                    const body = win.querySelector('.window-body');
                    const scrollContent = body.querySelector('.scroll-content');
                    if (!header || !body || !scrollContent) {
                        console.error("Pencere yapÄ±sÄ± bozuk:", win);
                        return;
                    }
                    
                    if (!doc.exists()) {
                        scrollContent.innerHTML = `<p class="whitespace-pre-wrap">Veri bekleniyor...</p>`;
                        setupMarquee(body, scrollContent);
                        return;
                    }
                    
                    const data = doc.data();
                    
                    // Bilgi penceresi baÅŸlÄ±ÄŸÄ±nÄ± dinamik olarak ayarla
                    if (id === 'info' && data.title) {
                        header.textContent = data.title;
                    }
                    
                    // Duyuru penceresi baÅŸlÄ±ÄŸÄ±nÄ± ve rengini ayarla
                    if (id === 'announcement') {
                        header.textContent = data.title || 'ğŸ“¢ Duyuru Panosu';
                        if (data.urgency === 'acil') {
                            header.style.background = "rgba(220, 38, 38, 0.7)"; 
                            header.style.color = "white";
                        } else if (data.urgency === 'onemli') {
                            header.style.background = "rgba(245, 158, 11, 0.7)"; 
                            header.style.color = "black";
                        } else {
                            header.style.background = "rgba(255, 255, 255, 0.8)"; 
                            header.style.color = "#1a202c";
                        }
                    }
                    
                    // Ä°Ã§eriÄŸi ayarla (HTML'i gÃ¼venli hale getir)
                    const formattedText = (data.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                    scrollContent.innerHTML = `<p class="whitespace-pre-wrap">${formattedText}</p>`;
                    
                    // Otomatik kaydÄ±rmayÄ± ayarla
                    setupMarquee(body, scrollContent);

                    // Yeni iÃ§erik geldiÄŸinde parlama efekti
                    if (pulseEffect) {
                        win.classList.remove('window-pulse');
                        void win.offsetWidth; 
                        win.classList.add('window-pulse');
                    }
                }

                function applyLayout(layoutType) {
                    const wAnnounce = windows.announcement;
                    const wInfo = windows.info;
                    if (!wAnnounce || !wInfo) return;

                    // Ã–nce gÃ¶rÃ¼nÃ¼r yap
                    wAnnounce.style.display = 'flex';
                    wInfo.style.display = 'flex';
                    
                    const pad = 20; // Ekran kenar boÅŸluÄŸu
                    const W = receiverScreen.clientWidth - (pad * 2); // KullanÄ±labilir geniÅŸlik
                    const H = receiverScreen.clientHeight - (pad * 2); // KullanÄ±labilir yÃ¼kseklik
                    const gap = 20; // Pencereler arasÄ± boÅŸluk

                    switch (layoutType) {
                        case 'left-right':
                            wAnnounce.style.top = `${pad}px`;
                            wAnnounce.style.left = `${pad}px`;
                            wAnnounce.style.width = `${(W - gap) / 2}px`;
                            wAnnounce.style.height = `${H}px`;
                            
                            wInfo.style.top = `${pad}px`;
                            wInfo.style.left = `${(W + gap) / 2 + pad}px`;
                            wInfo.style.width = `${(W - gap) / 2}px`;
                            wInfo.style.height = `${H}px`;
                            break;
                        
                        case 'full-announcement':
                            wAnnounce.style.top = `${pad}px`;
                            wAnnounce.style.left = `${pad}px`;
                            wAnnounce.style.width = `${W}px`;
                            wAnnounce.style.height = `${H}px`;
                            wInfo.style.display = 'none'; // Bilgi penceresini gizle
                            break;
                            
                        case 'full-info':
                            wInfo.style.top = `${pad}px`;
                            wInfo.style.left = `${pad}px`;
                            wInfo.style.width = `${W}px`;
                            wInfo.style.height = `${H}px`;
                            wAnnounce.style.display = 'none'; // Duyuru penceresini gizle
                            break;

                        case 'top-bottom':
                            wAnnounce.style.top = `${pad}px`;
                            wAnnounce.style.left = `${pad}px`;
                            wAnnounce.style.width = `${W}px`;
                            wAnnounce.style.height = `${(H - gap) / 2}px`;
                            
                            wInfo.style.top = `${(H + gap) / 2 + pad}px`;
                            wInfo.style.left = `${pad}px`;
                            wInfo.style.width = `${W}px`;
                            wInfo.style.height = `${(H - gap) / 2}px`;
                            break;
                    }
                    
                    // DÃ¼zen deÄŸiÅŸiminden sonra kaydÄ±rmayÄ± yeniden hesapla
                    // KÃ¼Ã§Ã¼k bir gecikme (transition sÃ¼resi)
                    setTimeout(() => {
                        if (wAnnounce.style.display !== 'none') {
                            const annBody = wAnnounce.querySelector('.window-body');
                            const annContent = wAnnounce.querySelector('.scroll-content');
                            if (annBody && annContent) setupMarquee(annBody, annContent);
                        }
                        if (wInfo.style.display !== 'none') {
                            const infoBody = wInfo.querySelector('.window-body');
                            const infoContent = wInfo.querySelector('.scroll-content');
                            if (infoBody && infoContent) setupMarquee(infoBody, infoContent);
                        }
                    }, 500); // 0.5s animasyon sÃ¼resi
                }

                function setupMarquee(container, content) {
                    // Ã–nceki animasyonu temizle
                    const existingAnim = marqueeAnimations.find(a => a.target === content);
                    if (existingAnim) {
                        existingAnim.animation.cancel();
                        marqueeAnimations = marqueeAnimations.filter(a => a.target !== content);
                    }
                    
                    // KaydÄ±rmayÄ± sÄ±fÄ±rla
                    content.style.transform = 'translateY(0px)';

                    // Gecikmeli hesaplama (DOM'un oturmasÄ± iÃ§in)
                    setTimeout(() => {
                        if (!container || !content) return; // GÃ¼venlik kontrolÃ¼
                        const containerHeight = container.clientHeight;
                        const contentHeight = content.scrollHeight;
                        
                        if (contentHeight > containerHeight) {
                            const distance = contentHeight - containerHeight;
                            // HÄ±zÄ± ayarla (Ã¶rn: 40 piksel/saniye)
                            const duration = (distance / 40) * 1000; 
                            
                            // BaÅŸlangÄ±Ã§ta 3 saniye bekle, sonra kay, sonra 3 saniye bekle
                            const totalDuration = duration + 6000; // 3s + 3s bekleme
                            const scrollStart = 3000 / totalDuration; // % olarak
                            const scrollEnd = (duration + 3000) / totalDuration; // % olarak

                            const animation = content.animate([
                                { transform: 'translateY(0px)' }, // BaÅŸlangÄ±Ã§ (0%)
                                { transform: 'translateY(0px)', offset: scrollStart }, // BaÅŸlangÄ±Ã§ bekleme
                                { transform: `translateY(-${distance}px)`, offset: scrollEnd }, // BitiÅŸ
                                { transform: `translateY(-${distance}px)`}, // BitiÅŸ bekleme
                                { transform: 'translateY(0px)', offset: 1.0 } // BaÅŸa dÃ¶n (animasyonu yumuÅŸatmak iÃ§in)
                            ], {
                                duration: totalDuration, 
                                iterations: Infinity,
                                easing: 'linear'
                            });
                            
                            marqueeAnimations.push({ target: content, animation: animation });
                        }
                    }, 100); // 100ms gecikme
                }


                function makeDraggable(element) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    const header = element.querySelector('.window-header');

                    if (header) {
                        header.onmousedown = dragMouseDown;
                    }

                    function dragMouseDown(e) {
                        e.preventDefault();
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                    }

                    function elementDrag(e) {
                        e.preventDefault();
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        // SÄ±nÄ±rlarÄ± belirle (ekran dÄ±ÅŸÄ±na Ã§Ä±kmasÄ±n)
                        const parent = receiverScreen;
                        let newTop = element.offsetTop - pos2;
                        let newLeft = element.offsetLeft - pos1;
                        
                        if (newTop < 0) newTop = 0;
                        if (newLeft < 0) newLeft = 0;
                        if (newTop + element.clientHeight > parent.clientHeight) newTop = parent.clientHeight - element.clientHeight;
                        if (newLeft + element.clientWidth > parent.clientWidth) newLeft = parent.clientWidth - element.clientWidth;

                        element.style.top = newTop + "px";
                        element.style.left = newLeft + "px";
                        
                        // SÃ¼rÃ¼klerken animasyonu duraklat
                        marqueeAnimations.forEach(a => {
                            if (a.animation.playState === 'running') a.animation.pause();
                        });
                    }

                    function closeDragElement() {
                        document.onmouseup = null;
                        document.onmousemove = null;
                        
                        // SÃ¼rÃ¼kleme bitince animasyonu yeniden baÅŸlat/ayarla
                        const body = element.querySelector('.window-body');
                        const content = element.querySelector('.scroll-content');
                        if (body && content) setupMarquee(body, content);
                        
                        marqueeAnimations.forEach(a => {
                            if (a.animation.playState === 'paused') a.animation.play();
                        });
                    }
                }
                
                // Ekran yeniden boyutlandÄ±ÄŸÄ±nda dÃ¼zeni yeniden uygula
                window.onresize = () => {
                    if(receiverScreen.classList.contains('hidden') === false) {
                        // Aktif olan dÃ¼zeni tekrar uygula (veya varsayÄ±lana dÃ¶n)
                        // Åimdilik varsayÄ±lana dÃ¶nÃ¼yoruz:
                        applyLayout('left-right'); 
                    }
                };
                
            }); // DOMContentLoaded sonu
        </script>
    </body>
    </html>
