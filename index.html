<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarÄ±ca UÄŸur Okulu - GerÃ§ek ZamanlÄ± Duyuru ğŸ“¢</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ekstra stil ve pÃ¼rÃ¼zsÃ¼z geÃ§iÅŸler */
        body, html {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* KaydÄ±rmayÄ± engelle */
            height: 100%;
        }
        
        /* AlÄ±cÄ± (TV) EkranÄ± Arka PlanÄ± */
        #receiver-desktop {
            background: linear-gradient(120deg, #f0f4f8 0%, #d9e2ec 100%);
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* SÃ¼rÃ¼klenebilir Pencereler */
        .draggable-window {
            position: absolute;
            z-index: 10;
            background: rgba(255, 255, 255, 0.6); /* YarÄ± saydam 'cam' efekti */
            border: 1px solid rgba(209, 213, 219, 0.8);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            min-width: 350px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Ä°Ã§eriÄŸin kÃ¶ÅŸelerden taÅŸmasÄ±nÄ± engelle */
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); /* YumuÅŸak geÃ§iÅŸ */
        }

        .window-header {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px 16px;
            cursor: move; /* SÃ¼rÃ¼kleme imleci */
            border-bottom: 1px solid rgba(209, 213, 219, 0.5);
            user-select: none; /* Metin seÃ§meyi engelle */
        }
        
        .window-content {
            padding: 20px;
            /* overflow-y: auto; */ /* Otomatik kaydÄ±rma iÃ§in bunu kaldÄ±rÄ±yoruz */
            flex-grow: 1;
            overflow: hidden; /* KaydÄ±rma efekti iÃ§in gerekli */
            position: relative; /* Kayan iÃ§erik iÃ§in */
        }

        /* --- YavaÅŸ Otomatik KaydÄ±rma (Marquee) Stili --- */
        .scrolling-content {
            position: relative;
            animation: scroll-up-down 20s linear infinite; /* Animasyon sÃ¼resi (20s) */
        }
        
        @keyframes scroll-up-down {
            0%, 10% { /* BaÅŸlangÄ±Ã§ta 10% bekle */
                transform: translateY(0%);
            }
            40%, 60% { /* %40'a kadar aÅŸaÄŸÄ± in, %60'a kadar bekle */
                transform: translateY(var(--scroll-amount)); 
            }
            90%, 100% { /* %90'a kadar yukarÄ± Ã§Ä±k, %100'e kadar bekle */
                transform: translateY(0%);
            }
        }
        /* --- KaydÄ±rma Stili Sonu --- */


        /* Hata animasyonu */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }

        /* Yeni Duyuru GeldiÄŸinde Animasyon (hafif parlama) */
        .highlight-flash {
            animation: flash-yellow 1.5s ease-out;
        }
        @keyframes flash-yellow {
            0% { background-color: rgba(253, 230, 138, 0.8); }
            70% { background-color: rgba(253, 230, 138, 0); }
            100% { background-color: rgba(255, 255, 255, 0.6); } /* Normal 'cam' rengine dÃ¶n */
        }
        
        /* YayÄ±ncÄ± (Windows) ArayÃ¼zÃ¼ */
        #publisher-ui {
            background-color: #f0f0f0; /* Klasik Windows grisi */
            border: 1px solid #999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .window-title-bar {
            background: linear-gradient(to right, #0058d0, #0078d7); /* Windows mavi baÅŸlÄ±k */
            color: white;
            padding: 6px 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-group {
            border: 1px solid #b0b0b0;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #fdfdfd;
        }
        .toolbar {
            background-color: #e9e9e9;
            border-bottom: 1px solid #b0b0b0;
            padding: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .toolbar-btn {
            background-color: #e1e1e1;
            border: 1px solid #b0b0b0;
            padding: 5px 10px;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .toolbar-btn:hover {
            background-color: #e5f1ff;
            border-color: #0078d7;
        }
        .status-bar {
            background-color: #e9e9e9;
            border-top: 1px solid #b0b0b0;
            padding: 4px 12px;
            font-size: 0.9em;
            color: #333;
        }

    </style>
</head>
<body class="bg-gray-300">

    <!-- Rol SeÃ§im EkranÄ± (TÃ¼m vÃ¼cudu kaplar) -->
    <div id="role-selection-screen" class="flex items-center justify-center min-h-screen bg-gray-200 p-4">
        <div class="bg-white p-8 md:p-12 shadow-2xl w-full max-w-md text-center">
            <h1 class="text-3xl font-bold mb-8 text-gray-800">DarÄ±ca UÄŸur Okulu Duyuru Sistemi</h1>
            <p class="text-gray-600 mb-10 text-lg">Bu cihazÄ± nasÄ±l kullanmak istiyorsunuz?</p>
            <div class="space-y-5">
                <button id="select-publisher" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 text-lg transition duration-300 transform hover:scale-105">
                    ğŸ“£ YayÄ±ncÄ± (Duyuru GÃ¶nder)
                </button>
                <button id="select-receiver" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 text-lg transition duration-300 transform hover:scale-105">
                    ğŸ“º AlÄ±cÄ± (TV EkranÄ±)
                </button>
            </div>
        </div>
    </div>

    <!-- Åifre EkranÄ± (TÃ¼m vÃ¼cudu kaplar) -->
    <div id="password-screen" class="hidden flex items-center justify-center min-h-screen bg-gray-200 p-4">
        <div class="bg-white p-8 md:p-12 shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">YayÄ±ncÄ± GiriÅŸi</h1>
            <p class="text-gray-600 mb-4">Duyuru yayÄ±nlamak iÃ§in ÅŸifreyi girin.</p>
            <input id="password-input" type="password" class="w-full p-3 bg-gray-100 border border-gray-400 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 text-lg transition duration-300">
                GiriÅŸ Yap
            </button>
            <p id="password-hint" class="text-gray-500 text-sm mt-4">Ä°pucu: ÅŸifre 1234</p>
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">HatalÄ± ÅŸifre!</p>
            <button id="back-to-roles" class="text-gray-500 hover:text-gray-800 text-sm mt-6">Geri</button>
        </div>
    </div>

    <!-- YayÄ±ncÄ± (Windows) ArayÃ¼zÃ¼ -->
    <div id="publisher-screen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8">
        <div id="publisher-ui" class="w-full max-w-4xl">
            <!-- BaÅŸlÄ±k Ã‡ubuÄŸu -->
            <div class="window-title-bar">
                <span>Duyuru YayÄ±nlama Paneli (DarÄ±ca UÄŸur Okulu)</span>
                <span id="publisher-clock" class="font-normal text-sm"></span>
            </div>
            
            <div class="p-4 md:p-6 flex flex-col md:flex-row gap-6">
                <!-- Sol Panel: Formlar -->
                <div class="flex-1 space-y-4">
                    <!-- Normal Duyuru Formu -->
                    <div class="form-group">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">1. Normal Duyuru GÃ¶nder</h2>
                        <div class="space-y-3">
                            <div>
                                <label for="title-input" class="block text-sm font-medium text-gray-700 mb-1">Duyuru BaÅŸlÄ±ÄŸÄ±:</label>
                                <input id="title-input" type="text" class="w-full p-2 bg-white border border-gray-400 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: Acil ToplantÄ±">
                            </div>
                            <div>
                                <label for="urgency-select" class="block text-sm font-medium text-gray-700 mb-1">Ã–nem Derecesi:</label>
                                <select id="urgency-select" class="w-full p-2 bg-white border border-gray-400 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="normal">Normal</option>
                                    <option value="onemli">Ã–nemli</option>
                                    <option value="acil">ğŸš¨ ACÄ°L ğŸš¨</option>
                                </select>
                            </div>
                            <div>
                                <label for="audience-select" class="block text-sm font-medium text-gray-700 mb-1">Kime:</label>
                                <select id="audience-select" class="w-full p-2 bg-white border border-gray-400 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="TÃ¼m Okul">TÃ¼m Okul</option>
                                    <option value="Ã–ÄŸrenciler">Ã–ÄŸrenciler</option>
                                    <option value="Ã–ÄŸretmenler">Ã–ÄŸretmenler</option>
                                    <option value="Veliler">Veliler</option>
                                </select>
                            </div>
                            <div>
                                <label for="announcement-input" class="block text-sm font-medium text-gray-700 mb-1">Duyuru DetayÄ±:</label>
                                <textarea id="announcement-input" rows="4" class="w-full p-2 bg-white border border-gray-400 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Duyuru ile ilgili detaylarÄ± buraya yazÄ±n..."></textarea>
                            </div>
                            <button id="publish-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 transition duration:300 disabled:opacity-50">
                                Duyuruyu YayÄ±nla ğŸš€
                            </button>
                        </div>
                    </div>
                     <!-- Kantin HÄ±zlÄ± ÅablonlarÄ± (Toolbar) -->
                    <div class="form-group">
                         <h2 class="text-xl font-semibold mb-3 text-gray-800">Kantin HÄ±zlÄ± ÅablonlarÄ±</h2>
                         <div class="toolbar">
                            <button data-template="menu" class="template-btn toolbar-btn">ğŸ½ï¸ MenÃ¼</button>
                            <button data-template="tost" class="template-btn toolbar-btn">ğŸ‰ Tost GÃ¼nÃ¼</button>
                            <button data-template="muzik" class="template-btn toolbar-btn">ğŸ¶ MÃ¼zik Ä°steÄŸi</button>
                            <button data-template="kapanis" class="template-btn toolbar-btn">ğŸ”” KapanÄ±ÅŸ</button>
                         </div>
                    </div>
                </div>
                
                <!-- SaÄŸ Panel: AnlÄ±k Ä°Ã§erik ve DÃ¼zen KontrolÃ¼ -->
                <div class="flex-1 space-y-4">
                    <!-- AnlÄ±k Ä°Ã§erik OluÅŸturucular -->
                    <div class="form-group">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">2. AnlÄ±k Ä°Ã§erik GÃ¶nder</h2>
                        <p class="text-sm text-gray-600 mb-3">(Bu iÃ§erik "GÃ¼nÃ¼n Bilgisi" penceresinde yayÄ±nlanÄ±r)</p>
                        <div class="space-y-3">
                            <!-- Hava Durumu butonu kaldÄ±rÄ±ldÄ± -->
                            <button id="publish-fun-fact" class="w-full toolbar-btn text-left">ğŸ§  EÄŸlenceli Bilgi Ver</button>
                            <button id="publish-quote" class="w-full toolbar-btn text-left">ğŸ’¡ GÃ¼nÃ¼n SÃ¶zÃ¼nÃ¼ Ver</button>
                            <button id="publish-word" class="w-full toolbar-btn text-left">ğŸ‡¬ğŸ‡§ GÃ¼nÃ¼n Ä°ngilizce Kelimesini Ver</button>
                            <p id="ai-loading-indicator" class="text-sm text-gray-600 hidden">AI iÃ§erik Ã¼retiyor, lÃ¼tfen bekleyin...</p>
                        </div>
                    </div>

                    <!-- Ekran DÃ¼zeni KontrolÃ¼ (GÃœNCELLENDÄ°) -->
                    <div class="form-group">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">3. TV Ekran DÃ¼zeni KontrolÃ¼</h2>
                        <div class="space-y-3">
                            <button data-layout="default" class="layout-btn w-full toolbar-btn text-left">Sol/SaÄŸ (Duyuru / Bilgi)</button>
                            <button data-layout="full-announcement" class="layout-btn w-full toolbar-btn text-left">Tam Ekran (Sadece Duyuru)</button>
                            <button data-layout="full-info" class="layout-btn w-full toolbar-btn text-left">Tam Ekran (Sadece Bilgi)</button>
                            <button data-layout="top-bottom" class="layout-btn w-full toolbar-btn text-left">Ãœst/Alt (Duyuru / Bilgi)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Durum Ã‡ubuÄŸu -->
            <div class="status-bar">
                <span id="publisher-status" class="text-sm text-gray-700">Firebase baÄŸlantÄ±sÄ± bekleniyor...</span>
            </div>
        </div>
    </div>


    <!-- AlÄ±cÄ± (TV) EkranÄ± / MasaÃ¼stÃ¼ -->
    <div id="receiver-desktop" class="hidden">

        <!-- Duyuru Penceresi -->
        <div id="announcement-window" class="draggable-window" style="top: 20px; left: 20px; width: 55%; height: calc(100vh - 40px);">
            <div class="window-header">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“¢ Duyuru Panosu</h2>
            </div>
            <div id="announcement-content" class="window-content">
                <p id="loading-text" class="text-gray-600 italic text-xl">Duyurular bekleniyor...</p>
                <!-- Kayan iÃ§erik buraya gelecek -->
            </div>
        </div>

        <!-- Hava Durumu Penceresi (KALDIRILDI) -->
        
        <!-- Bilgi Penceresi (EÄŸlenceli Bilgi, SÃ¶z, Kelime) -->
        <div id="info-window" class="draggable-window" style="top: 20px; right: 20px; width: 40%; height: calc(100vh - 40px);">
            <div class="window-header">
                <h2 class="text-xl font-bold text-gray-800">ğŸ’¡ GÃ¼nÃ¼n Bilgisi</h2>
            </div>
            <div id="info-content" class="window-content">
                <p class="text-gray-600 italic text-xl">Veri bekleniyor...</p>
                <!-- Kayan iÃ§erik buraya gelecek -->
            </div>
        </div>

    </div>

    <!-- Hata MesajÄ± Konteyneri -->
    <div id="error-toast" class="hidden fixed bottom-5 right-5 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50">
        Hata: Bir sorun oluÅŸtu.
    </div>

    <!-- Firebase Scriptleri -->
    <script type="module">
        // Firebase modÃ¼llerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- YENÄ° VE TAM FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeQsh4Tp-YbLG8BcgoMDKXi5gJ0rBZ5pI",
            authDomain: "emirokuldeneme.firebaseapp.com",
            projectId: "emirokuldeneme",
            storageBucket: "emirokuldeneme.firebasestorage.app",
            messagingSenderId: "821824749207",
            appId: "1:821824749207:web:164b0ea4c79bf9636f33d2"
        };
        // -------------------------------------------

        // --- GEMINI API AYARLARI ---
        const GEMINI_API_KEY = "AIzaSyBx84HfcrsNwfEjK5kd-yGqrFC4nr_uDjc";
        // gemini-2.5-flash modelini kullanÄ±yoruz
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        // -------------------------------------------


        // --- Firebase BaÅŸlatma (Hata dÃ¼zeltmesi iÃ§in en baÅŸa alÄ±ndÄ±) ---
        let db, auth, userId;
        const appId = firebaseConfig.projectId || 'genel-duyuru-odasi';
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Hata ayÄ±klama loglarÄ±nÄ± aÃ§
        } catch (error) {
            console.error("Kritik Firebase BaÅŸlatma HatasÄ±:", error);
            showErrorToast(`Kritik Firebase HatasÄ±: ${error.message}`);
        }
        // ----------------------------------------------------------------

        // --- DokÃ¼man YollarÄ± (Hava durumu kaldÄ±rÄ±ldÄ±) ---
        const docPaths = {
            announcement: doc(db, 'artifacts', appId, 'public/data', 'broadcast', 'latestAnnouncement'),
            // weather: doc(...) // KaldÄ±rÄ±ldÄ±
            info: doc(db, 'artifacts', appId, 'public/data', 'broadcast', 'latestInfo'),
            layout: doc(db, 'artifacts', appId, 'public/data', 'broadcast', 'layoutConfig')
        };
        
        // --- DOM YÃœKLENDÄ°ÄÄ°NDE BAÅLA (TÃ¼m tuÅŸlarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in dÃ¼zeltme) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elementleri ---
            const roleScreen = document.getElementById('role-selection-screen');
            const selectPublisherBtn = document.getElementById('select-publisher');
            const selectReceiverBtn = document.getElementById('select-receiver');
            
            const passwordScreen = document.getElementById('password-screen');
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const passwordError = document.getElementById('password-error');
            const backToRolesBtn = document.getElementById('back-to-roles');

            const publisherScreen = document.getElementById('publisher-screen');
            const publisherStatus = document.getElementById('publisher-status');
            const publisherClock = document.getElementById('publisher-clock');
            const titleInput = document.getElementById('title-input');
            const urgencySelect = document.getElementById('urgency-select');
            const audienceSelect = document.getElementById('audience-select');
            const inputArea = document.getElementById('announcement-input');
            const publishButton = document.getElementById('publish-button');
            
            const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
            // const publishWeatherBtn = document.getElementById('publish-weather'); // KaldÄ±rÄ±ldÄ±
            const publishFunFactBtn = document.getElementById('publish-fun-fact');
            const publishQuoteBtn = document.getElementById('publish-quote');
            const publishWordBtn = document.getElementById('publish-word');

            const receiverDesktop = document.getElementById('receiver-desktop');
            const announcementWindow = document.getElementById('announcement-window');
            const announcementContent = document.getElementById('announcement-content');
            const loadingText = document.getElementById('loading-text');
            // const weatherWindow = document.getElementById('weather-window'); // KaldÄ±rÄ±ldÄ±
            const infoWindow = document.getElementById('info-window');
            const infoContent = document.getElementById('info-content');
            
            const errorToast = document.getElementById('error-toast');
            
            // --- Hata GÃ¶sterme Fonksiyonu ---
            function showErrorToast(message) {
                console.error("Hata GÃ¶sterildi:", message);
                errorToast.textContent = message;
                errorToast.classList.remove('hidden');
                setTimeout(() => {
                    errorToast.classList.add('hidden');
                }, 5000);
            }

            // --- Rol SeÃ§im OlaylarÄ± ---
            if (selectPublisherBtn) {
                selectPublisherBtn.addEventListener('click', () => {
                    roleScreen.classList.add('hidden');
                    passwordScreen.classList.remove('hidden');
                    passwordInput.focus();
                });
            }

            if (selectReceiverBtn) {
                selectReceiverBtn.addEventListener('click', () => {
                    startAppAs('receiver');
                });
            }

            if (backToRolesBtn) {
                backToRolesBtn.addEventListener('click', () => {
                    passwordScreen.classList.add('hidden');
                    roleScreen.classList.remove('hidden');
                    passwordError.classList.add('hidden');
                    passwordInput.value = "";
                });
            }

            // --- Åifre KontrolÃ¼ ---
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
                passwordInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }

            function handleLogin() {
                if (passwordInput.value === "1234") {
                    passwordScreen.classList.add('hidden');
                    passwordInput.value = "";
                    passwordError.classList.add('hidden');
                    startAppAs('publisher');
                } else {
                    passwordError.classList.remove('hidden');
                    passwordInput.classList.add('shake');
                    setTimeout(() => {
                        passwordInput.classList.remove('shake');
                    }, 500);
                }
            }

            // --- Uygulama BaÅŸlatma Fonksiyonu ---
            function startAppAs(role) {
                roleScreen.classList.add('hidden');
                
                if (role === 'publisher') {
                    publisherScreen.classList.remove('hidden');
                    setupAuth(role); // YayÄ±ncÄ± iÃ§in kimlik doÄŸrulama ve buton ayarlarÄ±
                } else {
                    receiverDesktop.classList.remove('hidden');
                    setupAuth(role); // AlÄ±cÄ± iÃ§in kimlik doÄŸrulama ve dinleyiciler
                }
            }

            // --- Firebase Kimlik DoÄŸrulama ---
            async function setupAuth(role) {
                try {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Kimlik doÄŸrulandÄ± (Anonim). Rol:", role);
                            
                            if (role === 'publisher') {
                                publisherStatus.textContent = "BaÄŸlandÄ± (HazÄ±r)";
                                setupPublisherControls();
                                // YayÄ±ncÄ± saatini baÅŸlat
                                setInterval(() => {
                                    publisherClock.textContent = new Date().toLocaleTimeString('tr-TR');
                                }, 1000);
                            } else {
                                setupReceiverListeners();
                            }
                        } else {
                            console.log("KullanÄ±cÄ± oturumu kapattÄ±.");
                            if (role === 'publisher') publisherStatus.textContent = "BaÄŸlantÄ± kesildi.";
                        }
                    });
                } catch (error) {
                    console.error("Kimlik doÄŸrulama hatasÄ±:", error);
                    showErrorToast(`Kimlik doÄŸrulama hatasÄ±: ${error.message}`);
                    if (role === 'publisher') publisherStatus.textContent = "Kimlik doÄŸrulama baÅŸarÄ±sÄ±z.";
                }
            }
            
            // --- YAYINCI FONKSÄ°YONLARI ---
            function setupPublisherControls() {
                publishButton.disabled = false;
                publishButton.addEventListener('click', publishAnnouncement);
                setupTemplateButtons(); // Kantin butonlarÄ±
                setupAiButtons(); // AI iÃ§erik butonlarÄ±
                setupLayoutButtons(); // DÃ¼zen butonlarÄ±
            }
            
            // Kantin ÅablonlarÄ±
            function setupTemplateButtons() {
                document.querySelectorAll('.template-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const template = e.currentTarget.dataset.template;
                        urgencySelect.value = 'normal';
                        audienceSelect.value = 'Ã–ÄŸrenciler';
                        
                        switch(template) {
                            case 'menu':
                                titleInput.value = "BugÃ¼nÃ¼n MenÃ¼sÃ¼ ğŸ½ï¸";
                                inputArea.value = "Afiyet olsun! BugÃ¼nkÃ¼ yemek listesi:\n1. ...\n2. ...\n3. ...";
                                break;
                            case 'tost':
                                titleInput.value = "ğŸ‰ SÃ¼rpriz Tost GÃ¼nÃ¼! ğŸ‰";
                                inputArea.value = "BugÃ¼n kantinde sÄ±cak ve lezzetli tostlar sizleri bekliyor!";
                                urgencySelect.value = 'onemli';
                                break;
                            case 'muzik':
                                titleInput.value = "ğŸ¶ MÃ¼zik Ä°steÄŸi ğŸ¶";
                                inputArea.value = "Ã–ÄŸle arasÄ±nda kantinde Ã§almasÄ±nÄ± istediÄŸiniz ÅŸarkÄ±larÄ±... (vb.)";
                                break;
                            case 'kapanis':
                                titleInput.value = "ğŸ”” Kantin KapanÄ±yor ğŸ””";
                                inputArea.value = "Kantinimiz 10 dakika iÃ§inde kapanacaktÄ±r.";
                                urgencySelect.value = 'acil';
                                break;
                        }
                        titleInput.focus();
                    });
                });
            }
            
            // AnlÄ±k Ä°Ã§erik (AI) ButonlarÄ± (Hava durumu kaldÄ±rÄ±ldÄ±)
            function setupAiButtons() {
                // publishWeatherBtn.addEventListener('click', () => callGeminiAndPublish('weather')); // KaldÄ±rÄ±ldÄ±
                publishFunFactBtn.addEventListener('click', () => callGeminiAndPublish('fun-fact'));
                publishQuoteBtn.addEventListener('click', () => callGeminiAndPublish('quote'));
                publishWordBtn.addEventListener('click', () => callGeminiAndPublish('word'));
            }
            
            // DÃ¼zen Kontrol ButonlarÄ±
            function setupLayoutButtons() {
                document.querySelectorAll('.layout-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const layout = e.currentTarget.dataset.layout;
                        try {
                            await setDoc(docPaths.layout, {
                                layout: layout,
                                timestamp: new Date().toISOString()
                            });
                            console.log("DÃ¼zen deÄŸiÅŸtirildi:", layout);
                        } catch (error) {
                            console.error("DÃ¼zen deÄŸiÅŸtirme hatasÄ±:", error);
                            showErrorToast(`DÃ¼zen deÄŸiÅŸtirilemedi: ${error.message}`);
                        }
                    });
                });
            }

            // Normal Duyuru YayÄ±nla
            async function publishAnnouncement() {
                const title = titleInput.value.trim();
                const text = inputArea.value.trim();
                if (!title || !text) {
                    showErrorToast("BaÅŸlÄ±k ve Detay alanlarÄ± boÅŸ bÄ±rakÄ±lamaz.");
                    return;
                }
                
                publishButton.disabled = true;
                publishButton.textContent = "YayÄ±nlanÄ±yor...";

                try {
                    await setDoc(docPaths.announcement, {
                        title: title,
                        text: text,
                        urgency: urgencySelect.value,
                        audience: audienceSelect.value,
                        timestamp: new Date().toLocaleString('tr-TR')
                    });
                    
                    titleInput.value = "";
                    inputArea.value = "";
                } catch (error) {
                    console.error("Duyuru yayÄ±nlama hatasÄ±:", error);
                    showErrorToast(`Duyuru gÃ¶nderilemedi: ${error.message}`);
                } finally {
                    publishButton.disabled = false;
                    publishButton.textContent = "Duyuruyu YayÄ±nla ğŸš€";
                }
            }
            
            // Gemini AI Fonksiyonu (Hava durumu kaldÄ±rÄ±ldÄ±)
            async function callGeminiAndPublish(type) {
                let prompt = "";
                let targetDoc = docPaths.info; // VarsayÄ±lan hedef "GÃ¼nÃ¼n Bilgisi" penceresi

                switch(type) {
                    // case 'weather': // KaldÄ±rÄ±ldÄ±
                    case 'fun-fact':
                        prompt = "Ä°lkokul ve ortaokul Ã¶ÄŸrencileri iÃ§in eÄŸlenceli, ÅŸaÅŸÄ±rtÄ±cÄ± ve kÄ±sa bir bilimsel bilgi ver (TV ekranÄ± iÃ§in).";
                        break;
                    case 'quote':
                        prompt = "TV ekranÄ±nda yayÄ±nlanmak Ã¼zere, Ã¶ÄŸrenciler iÃ§in motive edici, kÄ±sa ve anlamlÄ± bir sÃ¶z sÃ¶yle (ve kimin sÃ¶ylediÄŸini yaz).";
                        break;
                    case 'word':
                        prompt = "Return a JSON object with keys 'word', 'meaning', and 'example' for a common English word for Turkish middle school students. Format: {\"word\": \"...\", \"meaning\": \"...\", \"example\": \"...\"}";
                        break;
                }

                aiLoadingIndicator.classList.remove('hidden');
                setAiButtonsDisabled(true);

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        ...(type === 'word' && {
                            generationConfig: {
                                responseMimeType: "application/json",
                            }
                        })
                    };

                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Gemini API HatasÄ±: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0]) {
                        throw new Error("Gemini API'den geÃ§ersiz yanÄ±t alÄ±ndÄ±.");
                    }
                    
                    const aiText = result.candidates[0].content.parts[0].text;
                    let contentToPublish;

                    if (type === 'word') {
                        try {
                            const wordData = JSON.parse(aiText);
                            contentToPublish = {
                                type: 'word',
                                title: `ğŸ‡¬ğŸ‡§ GÃ¼nÃ¼n Kelimesi: ${wordData.word}`,
                                text: `<strong>AnlamÄ±:</strong> ${wordData.meaning}<br><strong>Ã–rnek:</strong> "${wordData.example}"`
                            };
                        } catch (e) {
                            console.error("JSON parse hatasÄ±:", e, "AlÄ±nan metin:", aiText);
                            throw new Error("GÃ¼nÃ¼n kelimesi formatÄ± anlaÅŸÄ±lamadÄ±.");
                        }
                    // } else if (type === 'weather') { // KaldÄ±rÄ±ldÄ±
                    //    contentToPublish = { type: 'weather', text: aiText };
                    } else if (type === 'fun-fact') {
                        contentToPublish = { type: 'fun-fact', title: 'ğŸ§  EÄŸlenceli Bilgi', text: aiText };
                    } else if (type === 'quote') {
                        contentToPublish = { type: 'quote', title: 'ğŸ’¡ GÃ¼nÃ¼n SÃ¶zÃ¼', text: aiText };
                    }
                    
                    // VeritabanÄ±na yaz
                    await setDoc(targetDoc, {
                        ...contentToPublish,
                        timestamp: new Date().toLocaleString('tr-TR')
                    });

                } catch (error) {
                    console.error("AI Ä°Ã§erik HatasÄ±:", error);
                    showErrorToast(`AI HatasÄ±: ${error.message}`);
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    setAiButtonsDisabled(false);
                }
            }
            
            function setAiButtonsDisabled(disabled) {
                [publishFunFactBtn, publishQuoteBtn, publishWordBtn].forEach(btn => {
                    if (btn) { // Butonun varlÄ±ÄŸÄ±nÄ± kontrol et (Ã¶nemli)
                        btn.disabled = disabled;
                        btn.style.opacity = disabled ? 0.6 : 1;
                    }
                });
            }
            
            // --- ALICI (TV EKRANI) FONKSÄ°YONLARI ---
            function setupReceiverListeners() {
                if (loadingText) loadingText.remove(); // YÃ¼kleniyor yazÄ±sÄ±nÄ± kaldÄ±r
                
                // 1. Duyuru Dinleyicisi
                onSnapshot(docPaths.announcement, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        const urgencyClass = getUrgencyStyles(data.urgency);
                        const urgencyLabel = getUrgencyLabel(data.urgency);
                        
                        const contentHTML = `
                            <div class="p-1 rounded-lg ${urgencyClass} fade-in">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="px-4 py-2 text-2xl font-semibold rounded ${urgencyClass === 'bg-red-200' ? 'bg-red-600 text-white' : (urgencyClass === 'bg-yellow-100' ? 'bg-yellow-500 text-black' : 'bg-gray-200 text-gray-800')}">
                                        ${urgencyLabel}
                                    </span>
                                    <span class="text-2xl text-gray-700 font-medium">Kime: ${data.audience}</span>
                                </div>
                                <h3 class="text-4xl font-bold text-black mb-4">${data.title}</h3>
                                <p class="text-3xl text-gray-800 whitespace-pre-wrap">${data.text}</p>
                                <p class="text-xl text-gray-600 mt-6 text-right">${data.timestamp}</p>
                            </div>
                        `;
                        // Yeni iÃ§erik iÃ§in kaydÄ±rma fonksiyonunu Ã§aÄŸÄ±r
                        updateScrollingContent(announcementContent, contentHTML);
                        
                        // Pencereye parlama efekti ekle
                        announcementWindow.classList.add('highlight-flash');
                        setTimeout(() => announcementWindow.classList.remove('highlight-flash'), 1500);
                    }
                }, (error) => showErrorToast(`Duyuru dinleme hatasÄ±: ${error.message}`));
                
                // 2. Hava Durumu Dinleyicisi (KALDIRILDI)
                
                // 3. Bilgi (SÃ¶z, Kelime) Dinleyicisi
                onSnapshot(docPaths.info, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        // Gelen 'type'a gÃ¶re baÅŸlÄ±ÄŸÄ± deÄŸiÅŸtir
                        document.querySelector('#info-window .window-header h2').textContent = data.title || "ğŸ’¡ GÃ¼nÃ¼n Bilgisi";
                        
                        const contentHTML = `<p class="text-3xl text-gray-800 whitespace-pre-wrap">${data.text}</p><p class="text-xl text-gray-600 mt-6 text-right">${data.timestamp}</p>`;
                        // Yeni iÃ§erik iÃ§in kaydÄ±rma fonksiyonunu Ã§aÄŸÄ±r
                        updateScrollingContent(infoContent, contentHTML);
                        
                        infoWindow.classList.add('highlight-flash');
                        setTimeout(() => infoWindow.classList.remove('highlight-flash'), 1500);
                    }
                }, (error) => showErrorToast(`Bilgi dinleme hatasÄ±: ${error.message}`));
                
                // 4. DÃ¼zen (Layout) Dinleyicisi
                onSnapshot(docPaths.layout, (doc) => {
                    if (doc.exists()) {
                        const layout = doc.data().layout;
                        console.log("Yeni dÃ¼zen alÄ±nÄ±yor:", layout);
                        applyLayout(layout);
                    }
                }, (error) => showErrorToast(`DÃ¼zen dinleme hatasÄ±: ${error.message}`));

                // Pencereleri SÃ¼rÃ¼klenebilir Yap
                makeWindowsDraggable();
            }

            // --- YENÄ°: Otomatik KaydÄ±rma Fonksiyonu ---
            // Global deÄŸiÅŸken animasyon hÄ±zÄ±nÄ± (saniye) tutar
            let scrollSpeedFactor = 20; // VarsayÄ±lan 20 saniye (YavaÅŸ)

            function updateScrollingContent(container, html) {
                // 1. Mevcut animasyonu ve iÃ§eriÄŸi temizle
                let oldScroller = container.querySelector('.scrolling-content');
                if (oldScroller) {
                    oldScroller.style.animation = 'none'; // Animasyonu durdur
                    container.innerHTML = ''; // Ä°Ã§eriÄŸi temizle
                }

                // 2. Yeni iÃ§eriÄŸi ekle
                const scroller = document.createElement('div');
                scroller.className = 'scrolling-content';
                scroller.innerHTML = html;
                container.appendChild(scroller);

                // 3. Gerekli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                // (KÄ±sa bir gecikme ile DOM'un gÃ¼ncellenmesini bekle)
                setTimeout(() => {
                    const containerHeight = container.clientHeight;
                    const contentHeight = scroller.scrollHeight;
                    
                    if (contentHeight > containerHeight) {
                        // 4. Evet, sÄ±ÄŸmÄ±yor -> Animasyonu baÅŸlat
                        const scrollAmount = containerHeight - contentHeight - 10; // 10px pay bÄ±rak
                        // Ä°Ã§erik uzunluÄŸuna gÃ¶re hÄ±zÄ± ayarla (Ã¶rn: her 100px iÃ§in 5 saniye)
                        scrollSpeedFactor = Math.max(20, (contentHeight / 100) * 5); // Minimum 20 saniye
                        
                        scroller.style.setProperty('--scroll-amount', `${scrollAmount}px`);
                        scroller.style.animation = `scroll-up-down ${scrollSpeedFactor}s linear infinite`;
                        console.log(`KaydÄ±rma aktif: HÄ±z ${scrollSpeedFactor}s`);
                    } else {
                        // 5. HayÄ±r, sÄ±ÄŸÄ±yor -> Animasyona gerek yok
                        scroller.style.animation = 'none';
                        console.log("Ä°Ã§erik sÄ±ÄŸÄ±yor, kaydÄ±rma durdu.");
                    }
                }, 100);
            }

            // DÃ¼zen Uygulama Fonksiyonu (GÃœNCELLENDÄ°)
            function applyLayout(layout) {
                // Ã–nce tÃ¼m pencereleri gÃ¶rÃ¼nÃ¼r yap
                [announcementWindow, infoWindow].forEach(win => {
                    if(win) win.style.display = 'flex';
                });
                // if (weatherWindow) weatherWindow.style.display = 'flex'; // KaldÄ±rÄ±ldÄ±

                if (layout === 'default') {
                    // Sol / SaÄŸ DÃ¼zeni
                    announcementWindow.style.cssText = 'top: 20px; left: 20px; width: 55%; height: calc(100vh - 40px);';
                    infoWindow.style.cssText = 'top: 20px; right: 20px; width: 40%; height: calc(100vh - 40px);';
                    // weatherWindow.style.display = 'none'; // KaldÄ±rÄ±ldÄ±
                } else if (layout === 'full-announcement') {
                    // Sadece Duyuru (Tam Ekran)
                    announcementWindow.style.cssText = 'top: 20px; left: 20px; width: calc(100vw - 40px); height: calc(100vh - 40px); z-index: 20;';
                    infoWindow.style.display = 'none';
                    // weatherWindow.style.display = 'none'; // KaldÄ±rÄ±ldÄ±
                } else if (layout === 'full-info') {
                    // YENÄ°: Sadece Bilgi (Tam Ekran)
                    infoWindow.style.cssText = 'top: 20px; left: 20px; width: calc(100vw - 40px); height: calc(100vh - 40px); z-index: 20;';
                    announcementWindow.style.display = 'none';
                    // weatherWindow.style.display = 'none'; // KaldÄ±rÄ±ldÄ±
                } else if (layout === 'top-bottom') {
                    // YENÄ°: Ãœst/Alt DÃ¼zeni
                    announcementWindow.style.cssText = 'top: 20px; left: 20px; width: calc(100vw - 40px); height: 48%;';
                    infoWindow.style.cssText = 'bottom: 20px; left: 20px; width: calc(100vw - 40px); height: 48%;';
                    // weatherWindow.style.display = 'none'; // KaldÄ±rÄ±ldÄ±
                }

                // DÃ¼zen deÄŸiÅŸiminden sonra kaydÄ±rmayÄ± yeniden hesapla
                // (KÃ¼Ã§Ã¼k bir gecikme ile geÃ§iÅŸ animasyonunun bitmesini bekle)
                setTimeout(() => {
                    if (announcementContent.innerHTML) updateScrollingContent(announcementContent, announcementContent.querySelector('.scrolling-content')?.innerHTML);
                    if (infoContent.innerHTML) updateScrollingContent(infoContent, infoContent.querySelector('.scrolling-content')?.innerHTML);
                }, 500); // 0.5s CSS geÃ§iÅŸ sÃ¼resi
            }

            // --- YardÄ±mcÄ± Fonksiyonlar ---
            
            // Ã–nem Derecesine GÃ¶re Stil
            function getUrgencyStyles(urgency) {
                switch (urgency) {
                    case 'acil': return 'bg-red-200 border-red-400';
                    case 'onemli': return 'bg-yellow-100 border-yellow-300';
                    default: return 'bg-white border-gray-300';
                }
            }
            function getUrgencyLabel(urgency) {
                switch (urgency) {
                    case 'acil': return 'ğŸš¨ ACÄ°L';
                    case 'onemli': return 'Ã–NEMLÄ°';
                    default: return 'Normal';
                }
            }

            // SÃ¼rÃ¼kle-BÄ±rak FonksiyonlarÄ±
            function makeWindowsDraggable() {
                document.querySelectorAll('.draggable-window').forEach(dragWindow);
            }

            function dragWindow(elmnt) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                const header = elmnt.querySelector(".window-header");

                if (header) {
                    header.onmousedown = dragMouseDown;
                } else {
                    elmnt.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // TÃ¼m pencerelerin z-index'ini sÄ±fÄ±rla
                    document.querySelectorAll('.draggable-window').forEach(win => win.style.zIndex = 10);
                    // TÄ±klananÄ± en Ã¼ste al
                    elmnt.style.zIndex = 15;
                    
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    // Ekran sÄ±nÄ±rlarÄ± iÃ§inde kalmasÄ±nÄ± saÄŸla
                    let newTop = Math.max(0, Math.min(elmnt.offsetTop - pos2, window.innerHeight - elmnt.offsetHeight));
                    let newLeft = Math.max(0, Math.min(elmnt.offsetLeft - pos1, window.innerWidth - elmnt.offsetWidth));

                    elmnt.style.top = newTop + "px";
                    elmnt.style.left = newLeft + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }

        }); // DOMContentLoaded sonu

    </script>
</body>
</html>
