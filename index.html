<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarÄ±ca UÄŸur Okulu - GerÃ§ek ZamanlÄ± Duyuru ğŸ“¢</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ekstra stil ve pÃ¼rÃ¼zsÃ¼z geÃ§iÅŸler */
        body {
            font-family: 'Inter', sans-serif;
        }
        #announcement-display {
            transition: all 0.3s ease;
            word-wrap: break-word;
        }
        /* Basit animasyon iÃ§in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hata animasyonu */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- 1. Rol SeÃ§im EkranÄ± (BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r) -->
    <div id="role-selection-screen" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center fade-in">
        <h1 class="text-2xl font-bold mb-6 text-blue-400">DarÄ±ca UÄŸur Okulu Duyuru Sistemi</h1>
        <p class="text-gray-300 mb-8">Bu cihazÄ± nasÄ±l kullanmak istiyorsunuz?</p>
        <div class="space-y-4">
            <button id="select-publisher" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
                ğŸ“£ YayÄ±ncÄ± (Duyuru GÃ¶nder)
            </button>
            <button id="select-receiver" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
                ğŸ§ AlÄ±cÄ± (Sadece Duyuru Al)
            </button>
        </div>
    </div>

    <!-- 2. Åifre EkranÄ± (Gizli) -->
    <div id="password-screen" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center hidden fade-in">
        <h1 class="text-2xl font-bold mb-6 text-blue-400">YayÄ±ncÄ± GiriÅŸi</h1>
        <p class="text-gray-300 mb-4">Duyuru yayÄ±nlamak iÃ§in ÅŸifreyi girin.</p>
        <input id="password-input" type="password" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
            GiriÅŸ Yap
        </button>
        <p id="password-hint" class="text-gray-500 text-sm mt-4">Ä°pucu: ÅŸifre 1234</p>
        <p id="password-error" class="text-red-400 text-sm mt-2 hidden">HatalÄ± ÅŸifre!</p>
        <button id="back-to-roles" class="text-gray-400 hover:text-white text-sm mt-6">Geri</button>
    </div>


    <!-- 3. Ana Uygulama EkranÄ± (Gizli) -->
    <div id="main-app-screen" class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-lg hidden fade-in">
        <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-center mb-6 text-blue-400">
            <!-- BaÅŸlÄ±k JS ile ayarlanacak -->
        </h1>

        <!-- Sadece YayÄ±ncÄ±nÄ±n GÃ¶receÄŸi Alan -->
        <div id="publisher-controls" class="hidden space-y-4">
            
            <!-- Duyuru BaÅŸlÄ±ÄŸÄ± -->
            <div>
                <label for="title-input" class="block text-sm font-medium text-gray-300 mb-2">Duyuru BaÅŸlÄ±ÄŸÄ±:</label>
                <input id="title-input" type="text" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: Acil ToplantÄ±">
            </div>

            <!-- Ã–nem Derecesi -->
            <div>
                <label for="urgency-select" class="block text-sm font-medium text-gray-300 mb-2">Ã–nem Derecesi:</label>
                <select id="urgency-select" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="normal" class="text-white">Normal</option>
                    <option value="onemli" class="text-yellow-400">Ã–nemli</option>
                    <option value="acil" class="text-red-400">ğŸš¨ ACÄ°L ğŸš¨</option>
                </select>
            </div>

            <!-- Kime -->
            <div>
                <label for="audience-select" class="block text-sm font-medium text-gray-300 mb-2">Kime:</label>
                <select id="audience-select" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="tum-okul">TÃ¼m Okul</option>
                    <option value="ogrenciler">Ã–ÄŸrenciler</option>
                    <option value="ogretmenler">Ã–ÄŸretmenler</option>
                    <option value="veliler">Veliler</option>
                </select>
            </div>

            <!-- Duyuru DetayÄ± -->
            <div>
                <label for="announcement-input" class="block text-sm font-medium text-gray-300 mb-2">Duyuru DetayÄ±:</label>
                <textarea id="announcement-input" rows="4" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Duyuru ile ilgili detaylarÄ± buraya yazÄ±n..."></textarea>
            </div>
            
            <!-- Kantin HÄ±zlÄ± ÅablonlarÄ± -->
            <div class="border-t border-gray-700 pt-4">
                 <label class="block text-sm font-medium text-gray-300 mb-2">Kantin HÄ±zlÄ± ÅablonlarÄ±:</label>
                 <div class="flex flex-wrap gap-2">
                    <button data-template="menu" class="template-btn bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ½ï¸ MenÃ¼
                    </button>
                    <button data-template="tost" class="template-btn bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ‰ Tost GÃ¼nÃ¼
                    </button>
                    <button data-template="muzik" class="template-btn bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ¶ MÃ¼zik Ä°steÄŸi
                    </button>
                    <button data-template="kapanis" class="template-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ”” KapanÄ±ÅŸ
                    </button>
                 </div>
            </div>

            <!-- YayÄ±nla Butonu -->
            <button id="publish-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 ease-in-out transform hover:scale-105 mt-4" disabled>
                YayÄ±nla ğŸš€
            </button>

            <!-- AyÄ±rÄ±cÄ± -->
            <hr class="border-gray-700 my-6">
        </div>
        
        <!-- Son Duyuru GÃ¶rÃ¼ntÃ¼leme AlanÄ± (Herkes gÃ¶rÃ¼r) -->
        <div>
            <h2 class="text-xl font-semibold mb-3 text-gray-300">Son Gelen Duyuru:</h2>
            <div id="announcement-display" class="w-full min-h-[100px] p-4 bg-gray-700 rounded-lg border border-gray-600">
                <p id="loading-text" class="text-gray-400 italic">Duyurular bekleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase modÃ¼llerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase hata ayÄ±klama loglarÄ±nÄ± aÃ§
        setLogLevel('Debug');

        // --- DOM Elementleri ---
        const roleScreen = document.getElementById('role-selection-screen');
        const selectPublisherBtn = document.getElementById('select-publisher');
        const selectReceiverBtn = document.getElementById('select-receiver');
        
        const passwordScreen = document.getElementById('password-screen');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const passwordError = document.getElementById('password-error');
        const backToRolesBtn = document.getElementById('back-to-roles');

        const mainAppScreen = document.getElementById('main-app-screen');
        const appTitle = document.getElementById('app-title');
        const publisherControls = document.getElementById('publisher-controls');
        
        // Yeni yayÄ±ncÄ± alanlarÄ±
        const titleInput = document.getElementById('title-input');
        const urgencySelect = document.getElementById('urgency-select');
        const audienceSelect = document.getElementById('audience-select');
        const inputArea = document.getElementById('announcement-input'); // Bu artÄ±k "detay"
        
        const publishButton = document.getElementById('publish-button');
        const displayArea = document.getElementById('announcement-display');
        const loadingText = document.getElementById('loading-text');


        // --- YENÄ° VE TAM FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeQsh4Tp-YbLG8BcgoMDKXi5gJ0rBZ5pI",
            authDomain: "emirokuldeneme.firebaseapp.com",
            projectId: "emirokuldeneme",
            storageBucket: "emirokuldeneme.firebasestorage.app",
            messagingSenderId: "821824749207",
            appId: "1:821824749207:web:164b0ea4c79bf9636f33d2"
        };
        // -------------------------------------------

        // --- Firebase DeÄŸiÅŸkenleri ---
        let db;
        let auth;
        let userId;
        const appId = firebaseConfig.projectId || 'genel-duyuru-odasi';
        const broadcastDocRef = () => doc(db, 'artifacts', appId, 'public/data', 'announcements', 'latest');

        // --- Rol SeÃ§im OlaylarÄ± ---
        selectPublisherBtn.addEventListener('click', () => {
            roleScreen.classList.add('hidden');
            passwordScreen.classList.remove('hidden'); // Åifre ekranÄ±nÄ± gÃ¶ster
            passwordInput.focus();
        });

        selectReceiverBtn.addEventListener('click', () => {
            startAppAs('receiver'); // AlÄ±cÄ± doÄŸrudan baÅŸlar
        });

        backToRolesBtn.addEventListener('click', () => {
            passwordScreen.classList.add('hidden');
            roleScreen.classList.remove('hidden');
            passwordError.classList.add('hidden');
            passwordInput.value = "";
        });

        // --- ÅÄ°FRE KONTROLÃœ ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === "1234") {
                passwordScreen.classList.add('hidden');
                passwordInput.value = "";
                passwordError.classList.add('hidden');
                startAppAs('publisher'); // Åifre doÄŸru, yayÄ±ncÄ± olarak baÅŸlat
            } else {
                // Hata gÃ¶ster ve salla
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('shake');
                setTimeout(() => {
                    passwordInput.classList.remove('shake');
                    passwordError.classList.add('hidden');
                }, 1000);
            }
        });
        // Enter tuÅŸu ile giriÅŸ
        passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loginButton.click();
        });


        // --- Uygulama BaÅŸlatma Fonksiyonu ---
        function startAppAs(role) {
            roleScreen.classList.add('hidden'); // Rol ekranÄ±nÄ± gizle (zaten gizli olabilir)
            mainAppScreen.classList.remove('hidden');

            if (role === 'publisher') {
                appTitle.textContent = "ğŸ“¢ YayÄ±ncÄ± Paneli (DarÄ±ca UÄŸur Okulu)";
                publisherControls.classList.remove('hidden'); 
            } else {
                appTitle.textContent = "ğŸ§ Duyuru AlÄ±cÄ±sÄ± (DarÄ±ca UÄŸur Okulu)";
            }

            initializeAppAndAuth();
        }

        // --- Firebase BaÅŸlatma ve Kimlik DoÄŸrulama ---
        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuth();
            } catch (error) {
                console.error("Firebase baÅŸlatma hatasÄ±:", error);
                displayArea.innerHTML = `<p class="text-red-500">Hata: Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. ${error.message}</p>`;
                if(loadingText) loadingText.remove();
            }
        }

        async function setupAuth() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Kimlik doÄŸrulandÄ± (Anonim). KullanÄ±cÄ± ID:", userId);
                        setupRealtimeListener(); // Dinleyiciyi baÅŸlat

                        if (publisherControls.classList.contains('hidden') === false) {
                            publishButton.addEventListener('click', publishAnnouncement);
                            publishButton.disabled = false;
                            setupTemplateButtons(); // Åablon butonlarÄ±nÄ± ayarla
                        }
                    } else {
                        console.log("KullanÄ±cÄ± oturumu kapattÄ±.");
                        if(publishButton) publishButton.disabled = true;
                    }
                });
            } catch (error) {
                console.error("Kimlik doÄŸrulama hatasÄ±:", error);
                displayArea.innerHTML = `<p class="text-red-500">Hata: Kimlik doÄŸrulanamadÄ±. ${error.message}</p>`;
                if(loadingText) loadingText.remove();
            }
        }
        
        // --- Kantin ÅablonlarÄ±nÄ± Ayarla ---
        function setupTemplateButtons() {
            document.querySelectorAll('.template-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const template = e.target.dataset.template;
                    
                    // Ã–nce formu temizle
                    urgencySelect.value = 'normal';
                    audienceSelect.value = 'ogrenciler'; // Kantin genelde Ã¶ÄŸrencilere yÃ¶neliktir
                    
                    switch(template) {
                        case 'menu':
                            titleInput.value = "BugÃ¼nÃ¼n MenÃ¼sÃ¼ ğŸ½ï¸";
                            inputArea.value = "Afiyet olsun! BugÃ¼nkÃ¼ yemek listesi:\n1. ...\n2. ...\n3. ...";
                            break;
                        case 'tost':
                            titleInput.value = "ğŸ‰ SÃ¼rpriz Tost GÃ¼nÃ¼! ğŸ‰";
                            inputArea.value = "BugÃ¼n kantinde sÄ±cak ve lezzetli tostlar sizleri bekliyor! KaÃ§Ä±rmayÄ±n!";
                            urgencySelect.value = 'onemli';
                            break;
                        case 'muzik':
                            titleInput.value = "ğŸ¶ MÃ¼zik Ä°steÄŸi ğŸ¶";
                            inputArea.value = "Ã–ÄŸle arasÄ±nda Ã§almasÄ±nÄ± istediÄŸiniz ÅŸarkÄ±larÄ± bu postun altÄ±na yorum olarak yazabilirsiniz! (Not: Bu Ã¶zellik eklenmedi, sadece ÅŸablon)";
                            break;
                        case 'kapanis':
                            titleInput.value = "ğŸ”” Kantin KapanÄ±yor ğŸ””";
                            inputArea.value = "Kantinimiz 10 dakika iÃ§inde kapanacaktÄ±r. LÃ¼tfen ihtiyaÃ§larÄ±nÄ±zÄ± giderin.";
                            urgencySelect.value = 'acil';
                            break;
                    }
                    
                    // KullanÄ±cÄ±nÄ±n hemen gÃ¶rmesi iÃ§in alanlara odaklan
                    titleInput.focus();
                });
            });
        }

        // --- Ã–nem Derecesine GÃ¶re Stil Veren YardÄ±mcÄ± Fonksiyon ---
        function getUrgencyStyles(urgency) {
            switch (urgency) {
                case 'acil':
                    return 'bg-red-800 border-red-500';
                case 'onemli':
                    return 'bg-yellow-800 border-yellow-500';
                default:
                    return 'bg-gray-700 border-gray-600';
            }
        }
        function getUrgencyLabel(urgency) {
            switch (urgency) {
                case 'acil':
                    return 'ğŸš¨ ACÄ°L';
                case 'onemli':
                    return 'Ã–NEMLÄ°';
                default:
                    return 'Normal';
            }
        }

        // 2. Firestore'daki deÄŸiÅŸiklikleri gerÃ§ek zamanlÄ± dinle (GÃœNCELLENDÄ°)
        function setupRealtimeListener() {
            console.log("Duyuru dinleyicisi kuruluyor...");
            const docRef = broadcastDocRef();
            
            onSnapshot(docRef, (doc) => {
                if (loadingText) {
                    loadingText.style.display = 'none'; // YÃ¼kleniyor yazÄ±sÄ±nÄ± gizle
                }
                
                if (doc.exists()) {
                    const data = doc.data();
                    
                    // Veri eski formatta mÄ± (sadece text) yoksa yeni formatta mÄ± (title vb.)
                    if (data.text && !data.title) {
                        // Eski format uyumluluÄŸu
                        displayArea.innerHTML = `
                            <div class="p-4 rounded-lg bg-gray-700 border border-gray-600">
                                <p class="text-white text-lg">${data.text}</p>
                                <p class="text-gray-400 text-xs mt-2 text-right">YayÄ±nlanma: ${data.timestamp}</p>
                            </div>
                        `;
                    } else {
                        // Yeni Zengin Duyuru FormatÄ±
                        const urgencyClass = getUrgencyStyles(data.urgency);
                        const urgencyLabel = getUrgencyLabel(data.urgency);

                        displayArea.innerHTML = `
                            <div class="p-4 rounded-lg ${urgencyClass} border">
                                <!-- Ãœst Bilgi SatÄ±rÄ± -->
                                <div class="flex justify-between items-center mb-2">
                                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${data.urgency === 'acil' ? 'bg-red-200 text-red-900' : (data.urgency === 'onemli' ? 'bg-yellow-200 text-yellow-900' : 'bg-gray-200 text-gray-900')}">
                                        ${urgencyLabel}
                                    </span>
                                    <span class="text-sm text-gray-300 font-medium">Kime: ${data.audience}</span>
                                </div>
                                
                                <!-- BaÅŸlÄ±k -->
                                <h3 class="text-2xl font-bold text-white mb-2">${data.title}</h3>
                                
                                <!-- Detay (BoÅŸluklarÄ± korumak iÃ§in whitespace-pre-wrap) -->
                                <p class="text-white text-lg whitespace-pre-wrap">${data.text}</p>
                                
                                <!-- Zaman DamgasÄ± -->
                                <p class="text-gray-400 text-xs mt-4 text-right">YayÄ±nlanma: ${data.timestamp}</p>
                            </div>
                        `;
                    }
                } else {
                    displayArea.innerHTML = `<p class="text-gray-400 italic">HenÃ¼z bir duyuru yayÄ±nlanmadÄ±.</p>`;
                }
            }, (error) => {
                console.error("Veri dinleme hatasÄ± (onSnapshot):", error);
                displayArea.innerHTML = `<p class="text-red-500">Hata: Veri alÄ±namadÄ±. ${error.message}</p>`;
            });
        }

        // 3. Yeni duyuru yayÄ±nla (GÃœNCELLENDÄ°)
        async function publishAnnouncement() {
            const title = titleInput.value.trim();
            const text = inputArea.value.trim();
            const urgency = urgencySelect.value;
            const audience = audienceSelect.value;

            if (!title || !text) {
                console.warn("BaÅŸlÄ±k ve Detay alanlarÄ± boÅŸ bÄ±rakÄ±lamaz.");
                // Hata mesajÄ± veya stil ekleyebilirsin
                return;
            }

            publishButton.disabled = true;
            publishButton.textContent = "YayÄ±nlanÄ±yor...";

            try {
                await setDoc(broadcastDocRef(), {
                    title: title,
                    text: text,
                    urgency: urgency,
                    audience: audience,
                    timestamp: new Date().toLocaleString('tr-TR'),
                    publishedBy: userId 
                });

                // Formu temizle
                titleInput.value = "";
                inputArea.value = "";
                urgencySelect.value = "normal";
                audienceSelect.value = "tum-okul";
                
                console.log("Yeni duyuru baÅŸarÄ±yla yayÄ±nlandÄ±!");

            } catch (error) {
                console.error("Duyuru yayÄ±nlama hatasÄ± (setDoc):", error);
                displayArea.innerHTML += `<p class="text-red-500 text-sm mt-2">Hata: Duyuru gÃ¶nderilemedi.</p>`;
            } finally {
                publishButton.disabled = false;
                publishButton.textContent = "Duyuruyu YayÄ±nla ğŸš€";
            }
        }

    </script>
</body>
</html>
