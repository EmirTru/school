<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarÄ±ca UÄŸur Okulu - Bilgi EkranÄ± ğŸ–¥ï¸</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ana font ailesi */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* --- YayÄ±ncÄ± EkranÄ± (Windows Stili) Stilleri --- */
        
        /* Windows stili gÃ¶lgeli buton */
        .btn-windows {
            background-color: #f0f0f0;
            border: 1px solid #a0a0a0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6);
            transition: all 0.1s ease-in-out;
        }
        .btn-windows:hover {
            background-color: #e8e8e8;
            border-color: #888;
        }
        .btn-windows:active {
            background-color: #d0d0d0;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-windows:disabled {
            background-color: #f5f5f5;
            border-color: #c0c0c0;
            color: #a0a0a0;
            cursor: not-allowed;
        }
        
        /* Ana uygulama penceresi */
        .app-window {
            border: 1px solid #a0a0a0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Mavi baÅŸlÄ±k Ã§ubuÄŸu */
        .title-bar {
            background-color: #005a9e; /* Klasik Windows mavisi */
            padding: 4px 8px;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Grup kutusu (fieldset) stili */
        .group-box {
            border: 1px solid #c0c0c0;
            padding: 1rem;
            margin-top: 1rem;
            background-color: #f5f5f5; /* Hafif gri arka plan */
        }
        .group-box-legend {
            font-weight: bold;
            color: #333;
            margin-left: 0.5rem;
            padding: 0 0.25rem;
            background-color: #f5f5f5; /* Efsanenin arka planÄ± */
            position: relative;
            top: -0.7rem; /* Ã‡izginin Ã¼stÃ¼ne Ã§Ä±kar */
            display: inline-block;
        }


        /* --- AlÄ±cÄ± EkranÄ± (MasaÃ¼stÃ¼ Stili) Stilleri --- */
        
        /* "EÄŸlenceli ama resmi" masaÃ¼stÃ¼ arka planÄ± */
        .desktop-background {
            background-color: #f0f4f8; /* AÃ§Ä±k mavi-gri */
            background-image:
                linear-gradient(rgba(255, 255, 255, .05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, .05) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden; /* SÃ¼rÃ¼klenen pencereler taÅŸmasÄ±n */
        }
        
        /* SÃ¼rÃ¼kle-bÄ±rak pencereleri */
        .draggable-window {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.85); /* Hafif ÅŸeffaf "cam" efekti */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Resmi ama modern kÃ¶ÅŸeler */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-width: 300px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out; /* DÃ¼zen deÄŸiÅŸimi iÃ§in animasyon */
        }
        
        /* Pencere baÅŸlÄ±k Ã§ubuÄŸu (sÃ¼rÃ¼kleme alanÄ±) */
        .window-header {
            padding: 0.5rem 0.75rem;
            font-weight: bold;
            color: #333;
            background-color: rgba(255, 255, 255, 0.5); /* BaÅŸlÄ±k Ã§ubuÄŸu da yarÄ± ÅŸeffaf */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 8px 8px 0 0;
            cursor: move; /* SÃ¼rÃ¼kleme imleci */
            user-select: none; /* Metin seÃ§meyi engelle */
        }
        
        /* Pencere iÃ§eriÄŸi */
        .window-content {
            padding: 0.75rem;
            flex-grow: 1; /* Esne, alanÄ± doldur */
            overflow-y: auto; /* Ä°Ã§erik taÅŸarsa kaydÄ±r */
            max-height: 400px; /* Ã‡ok uzun olmasÄ±n */
        }
        
        /* Hata animasyonu (ÅŸifre vb.) */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        
        /* Yeni duyuru vurgulama animasyonu */
        .highlight-pulse {
            animation: highlight-pulse 1.5s ease-out;
        }
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0px rgba(251, 191, 36, 0.7); } /* SarÄ± */
            70% { box-shadow: 0 0 0 15px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0px rgba(251, 191, 36, 0); }
        }
        
        /* API YÃ¼kleniyor Spinner'Ä± */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-200 min-h-screen flex items-center justify-center p-4">

    <!-- 1. Rol SeÃ§im EkranÄ± -->
    <div id="role-selection-screen" class="app-window bg-white w-full max-w-md">
        <div class="title-bar">
            <span>DarÄ±ca UÄŸur Okulu - Bilgi EkranÄ± ğŸ–¥ï¸</span>
        </div>
        <div class="p-8 text-center">
            <h1 class="text-xl font-bold mb-6 text-gray-800">Cihaz Modu SeÃ§imi</h1>
            <p class="text-gray-600 mb-8">Bu cihazÄ± nasÄ±l kullanmak istiyorsunuz?</p>
            <div class="space-y-4">
                <button id="select-publisher" class="w-full btn-windows font-bold py-3 px-4 shadow-sm text-gray-800">
                    ğŸ‘¨â€ğŸ’» YayÄ±ncÄ± (YÃ¶netim Paneli)
                </button>
                <button id="select-receiver" class="w-full btn-windows font-bold py-3 px-4 shadow-sm text-gray-800">
                    ğŸ“º AlÄ±cÄ± (TV EkranÄ±)
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Åifre EkranÄ± (YayÄ±ncÄ± iÃ§in) -->
    <div id="password-screen" class="app-window bg-white w-full max-w-md hidden">
        <div class="title-bar">
            <span>YayÄ±ncÄ± GiriÅŸi</span>
        </div>
        <div class="p-8 text-center">
            <h1 class="text-xl font-bold mb-6 text-gray-800">YÃ¶netici Paneli GiriÅŸi</h1>
            <p class="text-gray-600 mb-4">LÃ¼tfen ÅŸifreyi girin.</p>
            <input id="password-input" type="password" class="w-full p-2 bg-white border border-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button id="login-button" class="w-full btn-windows bg-blue-600 text-white font-bold py-3 px-4 shadow-sm border-blue-700">
                GiriÅŸ Yap
            </button>
            <p id="password-hint" class="text-gray-500 text-sm mt-4">Ä°pucu: ÅŸifre 1234</p>
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">HatalÄ± ÅŸifre!</p>
            <button id="back-to-roles" class="text-gray-600 hover:text-blue-600 text-sm mt-6">Geri</button>
        </div>
    </div>

    <!-- 3. Ana Uygulama - YayÄ±ncÄ± Paneli (Windows Stili) -->
    <div id="publisher-screen" class="app-window bg-gray-200 w-full max-w-3xl hidden">
        <div class="title-bar">
            <span>ğŸ‘¨â€ğŸ’» YayÄ±ncÄ± Paneli (DarÄ±ca UÄŸur Okulu)</span>
            <span id="publisher-clock" class="text-sm">00:00:00</span>
        </div>
        
        <!-- AraÃ§ Ã‡ubuÄŸu (Kantin ÅablonlarÄ±) -->
        <div class="p-2 bg-gray-100 border-b border-gray-300 flex flex-wrap gap-2 items-center">
            <span class="text-sm font-semibold mr-2">HÄ±zlÄ± Åablonlar:</span>
            <button data-template="menu" class="template-btn btn-windows text-sm py-1 px-2">ğŸ½ï¸ MenÃ¼</button>
            <button data-template="tost" class="template-btn btn-windows text-sm py-1 px-2">ğŸ‰ Tost GÃ¼nÃ¼</button>
            <button data-template="muzik" class="template-btn btn-windows text-sm py-1 px-2">ğŸ¶ MÃ¼zik Ä°steÄŸi</button>
            <button data-template="kapanis" class="template-btn btn-windows text-sm py-1 px-2">ğŸ”” KapanÄ±ÅŸ</button>
        </div>

        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Sol SÃ¼tun: Formlar -->
            <div>
                <!-- Grup 1: Normal Duyuru -->
                <div class="group-box">
                    <span class="group-box-legend">Yeni Duyuru YayÄ±nla</span>
                    <div class="space-y-3">
                        <div>
                            <label for="title-input" class="block text-sm font-medium text-gray-700">BaÅŸlÄ±k:</label>
                            <input id="title-input" type="text" class="w-full p-2 bg-white border border-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: Acil ToplantÄ±">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label for="urgency-select" class="block text-sm font-medium text-gray-700">Ã–nem:</label>
                                <select id="urgency-select" class="w-full p-2 bg-white border border-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="normal">Normal</option>
                                    <option value="onemli">Ã–nemli</option>
                                    <option value="acil">ğŸš¨ ACÄ°L</option>
                                </select>
                            </div>
                            <div>
                                <label for="audience-select" class="block text-sm font-medium text-gray-700">Kime:</label>
                                <select id="audience-select" class="w-full p-2 bg-white border border-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="TÃ¼m Okul">TÃ¼m Okul</option>
                                    <option value="Ã–ÄŸrenciler">Ã–ÄŸrenciler</option>
                                    <option value="Ã–ÄŸretmenler">Ã–ÄŸretmenler</option>
                                    <option value="Veliler">Veliler</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="announcement-input" class="block text-sm font-medium text-gray-700">Detay:</label>
                            <textarea id="announcement-input" rows="3" class="w-full p-2 bg-white border border-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Duyuru detaylarÄ±..."></textarea>
                        </div>
                        <button id="publish-button" class="w-full btn-windows bg-blue-600 text-white font-bold py-2 px-4 shadow-sm border-blue-700" disabled>
                            YayÄ±nla ğŸš€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SaÄŸ SÃ¼tun: Kontroller -->
            <div>
                <!-- Grup 2: AnlÄ±k Ä°Ã§erik OluÅŸturucular (AI) -->
                <div class="group-box">
                    <span class="group-box-legend">AnlÄ±k Ä°Ã§erik (AI)</span>
                    <div class="space-y-2">
                        <button id="publish-weather" class="w-full btn-windows py-2 px-4 text-gray-800" disabled>
                            â˜€ï¸ DarÄ±ca Hava Durumunu Sun
                        </button>
                        <button id="publish-fact" class="w-full btn-windows py-2 px-4 text-gray-800" disabled>
                            ğŸ§  GÃ¼nÃ¼n Bilgisi (Rastgele)
                        </button>
                        <button id="publish-quote" class="w-full btn-windows py-2 px-4 text-gray-800" disabled>
                            ğŸ’¡ GÃ¼nÃ¼n SÃ¶zÃ¼
                        </button>
                        <button id="publish-word" class="w-full btn-windows py-2 px-4 text-gray-800" disabled>
                            ğŸ‡¬ğŸ‡§ GÃ¼nÃ¼n Ä°ngilizce Kelimesi
                        </button>
                        <div id="ai-loading-indicator" class="text-sm text-gray-600 flex items-center justify-center gap-2 hidden">
                            <div class="loader !w-4 !h-4 !border-2"></div>
                            <span>Gemini AI iÃ§erik Ã¼retiyor...</span>
                        </div>
                    </div>
                </div>

                <!-- Grup 3: Ekran DÃ¼zeni KontrolÃ¼ -->
                <div class="group-box">
                    <span class="group-box-legend">ğŸ–¥ï¸ TV Ekran DÃ¼zeni KontrolÃ¼</span>
                    <p class="text-xs text-gray-600 mb-2">TV'deki pencerelerin dÃ¼zenini anÄ±nda deÄŸiÅŸtir:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button data-layout="left-right" class="layout-btn btn-windows text-sm py-2 px-1" disabled>Sol/SaÄŸ</button>
                        <button data-layout="fullscreen" class="layout-btn btn-windows text-sm py-2 px-1" disabled>Tam Ekran</button>
                        <button data-layout="three-columns" class="layout-btn btn-windows text-sm py-2 px-1" disabled>ÃœÃ§ SÃ¼tun</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Durum Ã‡ubuÄŸu -->
        <div class="p-1 bg-gray-100 border-t border-gray-300 text-xs text-gray-700">
            BaÄŸlantÄ± Durumu: <span id="publisher-status" class="font-semibold text-red-700">BaÄŸlanÄ±yor...</span>
        </div>
    </div>


    <!-- 4. Ana Uygulama - AlÄ±cÄ± (TV) EkranÄ± (MasaÃ¼stÃ¼ Stili) -->
    <div id="receiver-screen" class="desktop-background w-full h-screen hidden">
        
        <!-- SÃ¼rÃ¼kle-bÄ±rak Pencereler -->
        <div id="announcement-window" class="draggable-window w-1/3" style="top: 20px; left: 20px;">
            <div class="window-header">ğŸ“¢ Duyuru Panosu</div>
            <div id="announcement-content" class="window-content">
                <p class="text-gray-500 italic">Duyurular bekleniyor...</p>
            </div>
            <!-- Duyuru iÃ§in durum Ã§ubuÄŸu -->
            <div id="announcement-status-bar" class="p-1 text-xs text-gray-700 bg-gray-100 border-t border-gray-200 rounded-b-lg">
                Durum: Bekleniyor...
            </div>
        </div>

        <div id="weather-window" class="draggable-window w-1/3" style="top: 20px; left: 36.66%;">
            <div class="window-header">â˜€ï¸ Hava Durumu</div>
            <div id="weather-content" class="window-content">
                <p class="text-gray-500 italic">Hava durumu bilgisi bekleniyor...</p>
            </div>
        </div>

        <div id="fact-window" class="draggable-window w-1/3" style="top: 20px; left: 71.33%;">
            <div class="window-header">ğŸ’¡ GÃ¼nÃ¼n Bilgisi</div>
            <div id="fact-content" class="window-content">
                <p class="text-gray-500 italic">EÄŸlenceli bilgi bekleniyor...</p>
            </div>
        </div>

    </div>

    <!-- Firebase ve Uygulama Scripti -->
    <script type="module">
        // Firebase modÃ¼llerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YENÄ° DÃœZELTME: TÃ¼m kodun, HTML yÃ¼klendikten sonra Ã§alÄ±ÅŸmasÄ±nÄ± garantile
        document.addEventListener('DOMContentLoaded', () => {

            // Firebase hata ayÄ±klama loglarÄ±nÄ± aÃ§
            setLogLevel('Debug');

            // --- DOM Elementleri ---
            const roleScreen = document.getElementById('role-selection-screen');
            const selectPublisherBtn = document.getElementById('select-publisher');
            const selectReceiverBtn = document.getElementById('select-receiver');
            
            const passwordScreen = document.getElementById('password-screen');
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const passwordError = document.getElementById('password-error');
            const backToRolesBtn = document.getElementById('back-to-roles');

            const publisherScreen = document.getElementById('publisher-screen');
            const publisherClock = document.getElementById('publisher-clock');
            const publisherStatus = document.getElementById('publisher-status');
            const titleInput = document.getElementById('title-input');
            const urgencySelect = document.getElementById('urgency-select');
            const audienceSelect = document.getElementById('audience-select');
            const inputArea = document.getElementById('announcement-input');
            const publishButton = document.getElementById('publish-button');
            
            const receiverScreen = document.getElementById('receiver-screen');
            const announcementWindow = document.getElementById('announcement-window');
            const announcementContent = document.getElementById('announcement-content');
            const announcementStatusBar = document.getElementById('announcement-status-bar');
            const weatherWindow = document.getElementById('weather-window');
            const weatherContent = document.getElementById('weather-content');
            const factWindow = document.getElementById('fact-window');
            const factContent = document.getElementById('fact-content');
            
            const publishWeatherBtn = document.getElementById('publish-weather');
            const publishFactBtn = document.getElementById('publish-fact');
            const publishQuoteBtn = document.getElementById('publish-quote'); // YENÄ°
            const publishWordBtn = document.getElementById('publish-word'); // YENÄ°
            const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
            
            const layoutButtons = document.querySelectorAll('.layout-btn');

            // --- YENÄ° VE TAM FIREBASE YAPILANDIRMASI ---
            const firebaseConfig = {
                apiKey: "AIzaSyBeQsh4Tp-YbLG8BcgoMDKXi5gJ0rBZ5pI",
                authDomain: "emirokuldeneme.firebaseapp.com",
                projectId: "emirokuldeneme",
                storageBucket: "emirokuldeneme.firebasestorage.app",
                messagingSenderId: "821824749207",
                appId: "1:821824749207:web:164b0ea4c79bf9636f33d2"
            };
            // -------------------------------------------

            // --- Firebase DeÄŸiÅŸkenleri (DÃœZELTME: BaÅŸlangÄ±Ã§ta baÅŸlatÄ±ldÄ±) ---
            let db, auth, userId;
            const appId = firebaseConfig.projectId || 'genel-duyuru-odasi';
            let app;

            // HATA DÃœZELTMESÄ°: Firebase'i hemen baÅŸlat
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase (app, db, auth) baÅŸarÄ±yla baÅŸlatÄ±ldÄ±.");
            } catch (error) {
                console.error("Kritik Firebase baÅŸlatma hatasÄ±:", error);
                alert("Firebase baÅŸlatÄ±lamadÄ±! LÃ¼tfen sayfayÄ± yenileyin.");
            }

            // Pencerelerin Firebase'deki yollarÄ± (ArtÄ±k 'db' tanÄ±mlÄ±)
            const docPaths = {
                announcement: doc(db, 'artifacts', appId, 'public/data', 'windows', 'announcement'),
                weather: doc(db, 'artifacts', appId, 'public/data', 'windows', 'weather'),
                fact: doc(db, 'artifacts', appId, 'public/data', 'windows', 'fact'),
                layout: doc(db, 'artifacts', appId, 'public/data', 'windows', 'layout')
            };
            
            // --- Gemini API (Hava Durumu ve EÄŸlenceli Bilgi) ---
            async function fetchWithRetry(url, payload, maxRetries = 3) {
                let attempt = 0;
                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        } else {
                            throw new Error("API'den beklenen formatta yanÄ±t alÄ±namadÄ±.");
                        }
                    } catch (error) {
                        console.warn(`Gemini API isteÄŸi denemesi ${attempt + 1} baÅŸarÄ±sÄ±z oldu:`, error);
                        attempt++;
                        if (attempt >= maxRetries) {
                            throw new Error(`API isteÄŸi ${maxRetries} denemeden sonra baÅŸarÄ±sÄ±z oldu: ${error.message}`);
                        }
                        await new Promise(res => setTimeout(res, 1000 * Math.pow(2, attempt - 1)));
                    }
                }
            }

            const GEMINI_API_KEY = ""; // Canvas ortamÄ± bunu otomatik doldurur
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            
            // 1. Hava Durumu Getir
            async function getWeatherData() {
                aiLoadingIndicator.classList.remove('hidden');
                publishWeatherBtn.disabled = true;
                try {
                    const systemPrompt = "KullanÄ±cÄ± DarÄ±ca, Kocaeli iÃ§in hava durumunu istiyor. Hava durumunu Google Search ile bul. CevabÄ± SADECE ÅŸu formatta ver: 'DarÄ±ca: [SÄ±caklÄ±k]Â°C, [Durum AÃ§Ä±klamasÄ± (Ã¶rn: ParÃ§alÄ± Bulutlu)] â˜€ï¸/â˜ï¸/ğŸŒ§ï¸'. BaÅŸka hiÃ§bir aÃ§Ä±klama ekleme.";
                    const payload = {
                        contents: [{ parts: [{ text: "DarÄ±ca, Kocaeli iÃ§in hava durumu nedir?" }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const weatherText = await fetchWithRetry(GEMINI_API_URL, payload);
                    await publishContent(docPaths.weather, { content: weatherText });
                    console.log("Hava durumu yayÄ±nlandÄ±:", weatherText);
                } catch (error) {
                    console.error("Hava durumu alÄ±namadÄ±:", error);
                    alert(`Hava durumu alÄ±namadÄ±: ${error.message}`);
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    publishWeatherBtn.disabled = false;
                }
            }

            // 2. EÄŸlenceli Bilgi Getir
            async function getFunFact() {
                aiLoadingIndicator.classList.remove('hidden');
                publishFactBtn.disabled = true;
                try {
                    const systemPrompt = "Okul Ã§ocuklarÄ± iÃ§in (ilkokul, ortaokul, lise seviyesi) uygun, bilim, tarih veya doÄŸa hakkÄ±nda ilginÃ§, eÄŸlenceli ve kÄ±sa (1-2 cÃ¼mlelik) bir bilgi Ã¼ret. BaÅŸka hiÃ§bir aÃ§Ä±klama ekleme. Sadece 'Biliyor muydunuz? ...' diye baÅŸla.";
                    const payload = {
                        contents: [{ parts: [{ text: "Bana eÄŸlenceli bir bilgi ver." }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const factText = await fetchWithRetry(GEMINI_API_URL, payload);
                    await publishContent(docPaths.fact, { content: factText, type: 'fact' }); // 'type' eklendi
                    console.log("EÄŸlenceli bilgi yayÄ±nlandÄ±:", factText);
                } catch (error) {
                    console.error("EÄŸlenceli bilgi alÄ±namadÄ±:", error);
                    alert(`EÄŸlenceli bilgi alÄ±namadÄ±: ${error.message}`);
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    publishFactBtn.disabled = false;
                }
            }

            // 3. YENÄ°: GÃ¼nÃ¼n SÃ¶zÃ¼nÃ¼ Getir
            async function getQuoteOfTheDay() {
                aiLoadingIndicator.classList.remove('hidden');
                publishQuoteBtn.disabled = true;
                try {
                    const systemPrompt = "Okul ortamÄ±na uygun, motive edici, ilham verici veya dÃ¼ÅŸÃ¼ndÃ¼rÃ¼cÃ¼ bir 'gÃ¼nÃ¼n sÃ¶zÃ¼' Ã¼ret. CevabÄ± SADECE ÅŸu formatta ver: '[SÃ¶z] - [KiÅŸi]'. BaÅŸka hiÃ§bir aÃ§Ä±klama ekleme.";
                    const payload = {
                        contents: [{ parts: [{ text: "Bana ilham verici bir sÃ¶z ver." }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const quoteText = await fetchWithRetry(GEMINI_API_URL, payload);
                    // "fact" yolunu kullanarak aynÄ± pencereye yayÄ±nla
                    await publishContent(docPaths.fact, { content: quoteText, type: 'quote' }); 
                    console.log("GÃ¼nÃ¼n sÃ¶zÃ¼ yayÄ±nlandÄ±:", quoteText);
                } catch (error) {
                    console.error("GÃ¼nÃ¼n sÃ¶zÃ¼ alÄ±namadÄ±:", error);
                    alert(`GÃ¼nÃ¼n sÃ¶zÃ¼ alÄ±namadÄ±: ${error.message}`);
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    publishQuoteBtn.disabled = false;
                }
            }

            // 4. YENÄ°: GÃ¼nÃ¼n Kelimesini Getir
            async function getWordOfTheDay() {
                aiLoadingIndicator.classList.remove('hidden');
                publishWordBtn.disabled = true;
                try {
                    const systemPrompt = "Ã–ÄŸrenciler iÃ§in 'gÃ¼nÃ¼n Ä°ngilizce kelimesi' Ã¼ret. CevabÄ± SADECE ÅŸu formatta ver: '[Ä°ngilizce Kelime] ([OkunuÅŸu]): [TÃ¼rkÃ§e AnlamÄ±]. Ã–rnek CÃ¼mle: [Ä°ngilizce Ã–rnek CÃ¼mle]'. BaÅŸka hiÃ§bir aÃ§Ä±klama ekleme.";
                    const payload = {
                        contents: [{ parts: [{ text: "Bana gÃ¼nÃ¼n Ä°ngilizce kelimesini ver." }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const wordText = await fetchWithRetry(GEMINI_API_URL, payload);
                    // "fact" yolunu kullanarak aynÄ± pencereye yayÄ±nla
                    await publishContent(docPaths.fact, { content: wordText, type: 'word' }); 
                    console.log("GÃ¼nÃ¼n kelimesi yayÄ±nlandÄ±:", wordText);
                } catch (error) {
                    console.error("GÃ¼nÃ¼n kelimesi alÄ±namadÄ±:", error);
                    alert(`GÃ¼nÃ¼n kelimesi alÄ±namadÄ±: ${error.message}`);
                } finally {
                    aiLoadingIndicator.classList.add('hidden');
                    publishWordBtn.disabled = false;
                }
            }


            // --- Rol SeÃ§im OlaylarÄ± (ArtÄ±k Ã‡alÄ±ÅŸmalÄ±) ---
            selectPublisherBtn.addEventListener('click', () => {
                roleScreen.classList.add('hidden');
                passwordScreen.classList.remove('hidden');
                passwordInput.focus();
            });

            selectReceiverBtn.addEventListener('click', () => {
                startAppAs('receiver');
            });

            backToRolesBtn.addEventListener('click', () => {
                passwordScreen.classList.add('hidden');
                roleScreen.classList.remove('hidden');
                passwordError.classList.add('hidden');
                passwordInput.value = "";
            });

            // --- Åifre KontrolÃ¼ ---
            loginButton.addEventListener('click', () => {
                if (passwordInput.value === "1234") {
                    passwordScreen.classList.add('hidden');
                    passwordInput.value = "";
                    passwordError.classList.add('hidden');
                    startAppAs('publisher');
                } else {
                    passwordError.classList.remove('hidden');
                    passwordInput.classList.add('shake');
                    setTimeout(() => {
                        passwordInput.classList.remove('shake');
                        passwordError.classList.add('hidden');
                    }, 1000);
                }
            });
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') loginButton.click();
            });

            // --- Uygulama BaÅŸlatma Fonksiyonu ---
            function startAppAs(role) {
                roleScreen.classList.add('hidden');
                
                if (role === 'publisher') {
                    publisherScreen.classList.remove('hidden');
                    updatePublisherClock(); // Saati baÅŸlat
                    setInterval(updatePublisherClock, 1000);
                } else {
                    receiverScreen.classList.remove('hidden');
                    setupDraggableWindows(); // SÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini baÅŸlat
                }

                setupAuth(role); // Firebase kimlik doÄŸrulamasÄ±nÄ± baÅŸlat
            }

            // --- Firebase Kimlik DoÄŸrulama ---
            async function setupAuth(role) {
                try {
                    // Not: signInAnonymously birden fazla kez Ã§aÄŸrÄ±lÄ±rsa mevcut oturumu kullanÄ±r
                    await signInAnonymously(auth);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log(`Kimlik doÄŸrulandÄ± (${role}). ID:`, userId);
                            
                            if (role === 'publisher') {
                                publisherStatus.textContent = "BaÄŸlandÄ± (Anonim)";
                                publisherStatus.classList.remove('text-red-700');
                                publisherStatus.classList.add('text-green-700');
                                setupPublisherControls(); // YayÄ±ncÄ± butonlarÄ±nÄ± aktif et
                            } else {
                                setupReceiverListeners(); // AlÄ±cÄ± dinleyicilerini baÅŸlat
                            }
                        } else {
                            if (role === 'publisher') {
                                 publisherStatus.textContent = "BaÄŸlantÄ± kesildi.";
                                 publisherStatus.classList.add('text-red-700');
                            }
                        }
                    });
                } catch (error) {
                    console.error("Kimlik doÄŸrulama hatasÄ±:", error);
                    if (role === 'publisher') {
                        publisherStatus.textContent = "Kimlik DoÄŸrulama HatasÄ±!";
                        publisherStatus.classList.add('text-red-700');
                    }
                }
            }

            // --- YayÄ±ncÄ± (Publisher) FonksiyonlarÄ± ---
            function setupPublisherControls() {
                // ButonlarÄ± aktif et
                publishButton.disabled = false;
                publishWeatherBtn.disabled = false;
                publishFactBtn.disabled = false;
                publishQuoteBtn.disabled = false; // YENÄ°
                publishWordBtn.disabled = false; // YENÄ°
                layoutButtons.forEach(btn => btn.disabled = false);

                // Olay dinleyicilerini ekle
                publishButton.addEventListener('click', publishStandardAnnouncement);
                publishWeatherBtn.addEventListener('click', getWeatherData);
                publishFactBtn.addEventListener('click', getFunFact);
                publishQuoteBtn.addEventListener('click', getQuoteOfTheDay); // YENÄ°
                publishWordBtn.addEventListener('click', getWordOfTheDay); // YENÄ°

                // Kantin ÅablonlarÄ±
                document.querySelectorAll('.template-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const template = e.target.dataset.template;
                        urgencySelect.value = 'normal';
                        audienceSelect.value = 'Ã–ÄŸrenciler';
                        switch(template) {
                            case 'menu':
                                titleInput.value = "BugÃ¼nÃ¼n MenÃ¼sÃ¼ ğŸ½ï¸";
                                inputArea.value = "Afiyet olsun! BugÃ¼nkÃ¼ yemek listesi:\n1. ...\n2. ...\n3. ...";
                                break;
                            case 'tost':
                                titleInput.value = "ğŸ‰ SÃ¼rpriz Tost GÃ¼nÃ¼! ğŸ‰";
                                inputArea.value = "BugÃ¼n kantinde sÄ±cak ve lezzetli tostlar sizleri bekliyor!";
                                urgencySelect.value = 'onemli';
                                break;
                            case 'muzik':
                                titleInput.value = "ğŸ¶ MÃ¼zik Ä°steÄŸi ğŸ¶";
                                inputArea.value = "Ã–ÄŸle arasÄ±nda Ã§almasÄ±nÄ± istediÄŸiniz ÅŸarkÄ±larÄ± belirtebilirsiniz.";
                                break;
                            case 'kapanis':
                                titleInput.value = "ğŸ”” Kantin KapanÄ±yor ğŸ””";
                                inputArea.value = "Kantinimiz 10 dakika iÃ§inde kapanacaktÄ±r.";
                                urgencySelect.value = 'acil';
                                break;
                        }
                        titleInput.focus();
                    });
                });

                // Ekran DÃ¼zeni Kontrol ButonlarÄ±
                layoutButtons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const layout = e.target.dataset.layout;
                        try {
                            await setDoc(docPaths.layout, { 
                                layoutName: layout, 
                                timestamp: new Date().toISOString() 
                            });
                            console.log(`Ekran dÃ¼zeni "${layout}" olarak ayarlandÄ±.`);
                        } catch (error) {
                            console.error("DÃ¼zen ayarlanÄ±rken hata:", error);
                            alert(`DÃ¼zen ayarlanamadÄ±: ${error.message}`);
                        }
                    });
                });
            }
            
            // Genel iÃ§erik yayÄ±nlama fonksiyonu
            async function publishContent(docRef, data) {
                await setDoc(docRef, {
                    ...data,
                    timestamp: new Date().toISOString(),
                    publishedBy: userId
                });
            }

            // Normal duyuruyu yayÄ±nla
            async function publishStandardAnnouncement() {
                const title = titleInput.value.trim();
                const text = inputArea.value.trim();
                if (!title || !text) {
                    alert("BaÅŸlÄ±k ve Detay alanlarÄ± boÅŸ bÄ±rakÄ±lamaz.");
                    return;
                }
                
                publishButton.disabled = true;
                publishButton.textContent = "YayÄ±nlanÄ±yor...";

                try {
                    await publishContent(docPaths.announcement, {
                        title: title,
                        text: text,
                        urgency: urgencySelect.value,
                        audience: audienceSelect.value,
                    });
                    
                    // Formu temizle
                    titleInput.value = "";
                    inputArea.value = "";
                    urgencySelect.value = "normal";
                    audienceSelect.value = "TÃ¼m Okul";
                    console.log("Yeni duyuru yayÄ±nlandÄ±!");

                } catch (error) {
                    console.error("Duyuru yayÄ±nlama hatasÄ±:", error);
                    alert(`Duyuru yayÄ±nlanamadÄ±: ${error.message}`);
                } finally {
                    publishButton.disabled = false;
                    publishButton.textContent = "YayÄ±nla ğŸš€";
                }
            }
            
            // YayÄ±ncÄ± saatini gÃ¼ncelle
            function updatePublisherClock() {
                publisherClock.textContent = new Date().toLocaleTimeString('tr-TR');
            }

            // --- AlÄ±cÄ± (Receiver) FonksiyonlarÄ± ---
            function setupReceiverListeners() {
                // 1. Duyuru Dinleyicisi
                onSnapshot(docPaths.announcement, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        const urgencyClass = data.urgency === 'acil' ? 'text-red-600' : (data.urgency === 'onemli' ? 'text-yellow-600' : 'text-gray-700');
                        const urgencyLabel = data.urgency === 'acil' ? 'ğŸš¨ ACÄ°L' : (data.urgency === 'onemli' ? 'Ã–NEMLÄ°' : 'Normal');

                        announcementContent.innerHTML = `
                            <h3 class="text-xl font-bold ${urgencyClass} mb-2">${data.title}</h3>
                            <p class="text-gray-800 text-base whitespace-pre-wrap mb-2">${data.text}</p>
                            <p class="text-xs text-gray-500 mt-2 border-t pt-1">
                                <b>Kime:</b> ${data.audience} | <b>Zaman:</b> ${new Date(data.timestamp).toLocaleTimeString('tr-TR')}
                            </p>
                        `;
                        announcementStatusBar.textContent = `Durum: ${urgencyLabel} (YayÄ±nlandÄ±: ${new Date(data.timestamp).toLocaleTimeString('tr-TR')})`;
                        announcementWindow.classList.add('highlight-pulse');
                        setTimeout(() => announcementWindow.classList.remove('highlight-pulse'), 1500);
                    }
                }, (error) => console.error("Duyuru dinleme hatasÄ±:", error));

                // 2. Hava Durumu Dinleyicisi
                onSnapshot(docPaths.weather, (doc) => {
                    if (doc.exists()) {
                        weatherContent.innerHTML = `<p class="text-xl font-semibold text-blue-700">${doc.data().content}</p>`;
                        weatherWindow.classList.add('highlight-pulse');
                        setTimeout(() => weatherWindow.classList.remove('highlight-pulse'), 1500);
                    }
                }, (error) => console.error("Hava durumu dinleme hatasÄ±:", error));

                // 3. EÄŸlenceli Bilgi / GÃ¼nÃ¼n Bilgisi Dinleyicisi (GÃœNCELLENDÄ°)
                onSnapshot(docPaths.fact, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        let contentHTML = '';

                        // Ä°Ã§erik tÃ¼rÃ¼ne gÃ¶re farklÄ± HTML oluÅŸtur
                        if (data.type === 'quote') {
                            const parts = data.content.split(' - ');
                            const quote = parts[0] || data.content;
                            const author = parts[1] || 'Bilinmiyor';
                            contentHTML = `<p class="text-lg italic text-indigo-700">"${quote}"</p><p class="text-sm font-semibold text-right text-indigo-900 mt-2">- ${author}</p>`;
                        
                        } else if (data.type === 'word') {
                            // Gelen formatÄ± parÃ§ala: [Kelime] ([OkunuÅŸ]): [Anlam]. Ã–rnek CÃ¼mle: [CÃ¼mle]
                            // HATA BURADAYDI: Fazladan "content" kelimesi kaldÄ±rÄ±ldÄ±.
                            const parts = data.content.match(/(.+?)\s\((.+?)\):\s(.+?)\.\sÃ–rnek CÃ¼mle:\s(.+)/);
                            if (parts) {
                                contentHTML = `
                                    <p class="text-xl font-bold text-teal-700">${parts[1]} <span class="text-lg font-normal">(${parts[2]})</span></p>
                                    <p class="text-md text-gray-800 font-medium">${parts[3]}</p>
                                    <p class="text-sm italic text-gray-600 mt-2">"${parts[4]}"</p>
                                `;
                            } else {
                                contentHTML = `<p class="text-base text-teal-800">${data.content}</p>`; // Hata olursa dÃ¼z metin
                            }

                        } else { // 'fact' (rastgele bilgi) veya tanÄ±msÄ±zsa
                            contentHTML = `<p class="text-base text-purple-800">${data.content}</p>`;
                        }
                        
                        factContent.innerHTML = contentHTML;
                        factWindow.classList.add('highlight-pulse');
                        setTimeout(() => factWindow.classList.remove('highlight-pulse'), 1500);
                    }
                }, (error) => console.error("Bilgi dinleme hatasÄ±:", error));

                // 4. Ekran DÃ¼zeni (Layout) Dinleyicisi
                onSnapshot(docPaths.layout, (doc) => {
                    if (doc.exists()) {
                        const layoutName = doc.data().layoutName;
                        console.log(`Yeni dÃ¼zen alÄ±ndÄ±: ${layoutName}`);
                        applyLayout(layoutName);
                    }
                }, (error) => console.error("DÃ¼zen dinleme hatasÄ±:", error));
            }

            // TV Ekran DÃ¼zenini Uygula
            function applyLayout(layoutName) {
                [announcementWindow, weatherWindow, factWindow].forEach(win => {
                    win.style.opacity = '1';
                    win.style.pointerEvents = 'auto';
                });
                
                const gap = "20px";
                const top = "20px";
                const bottom = "20px";
                
                switch(layoutName) {
                    case 'left-right':
                        announcementWindow.style.top = top;
                        announcementWindow.style.left = gap;
                        announcementWindow.style.width = `calc(66.66% - ${gap} - (${gap}/2))`;
                        announcementWindow.style.height = `calc(100vh - ${top} - ${bottom})`;
                        
                        weatherWindow.style.top = top;
                        weatherWindow.style.left = `calc(66.66% + (${gap}/2))`;
                        weatherWindow.style.width = `calc(33.33% - ${gap} - (${gap}/2))`;
                        weatherWindow.style.height = `calc(50vh - ${top} - (${gap}/2))`;
                        
                        factWindow.style.top = `calc(50vh + (${gap}/2))`;
                        factWindow.style.left = `calc(66.66% + (${gap}/2))`;
                        factWindow.style.width = `calc(33.33% - ${gap} - (${gap}/2))`;
                        factWindow.style.height = `calc(50vh - ${bottom} - (${gap}/2))`;
                        break;
                        
                    case 'fullscreen':
                        announcementWindow.style.top = top;
                        announcementWindow.style.left = gap;
                        announcementWindow.style.width = `calc(100vw - ${gap} - ${gap})`;
                        announcementWindow.style.height = `calc(100vh - ${top} - ${bottom})`;
                        
                        [weatherWindow, factWindow].forEach(win => {
                            win.style.opacity = '0';
                            win.style.pointerEvents = 'none';
                        });
                        break;
                        
                    case 'three-columns':
                        announcementWindow.style.top = top;
                        announcementWindow.style.left = gap;
                        announcementWindow.style.width = `calc(33.33% - ${gap} - (${gap}/3))`;
                        announcementWindow.style.height = `calc(100vh - ${top} - ${bottom})`;
                        
                        weatherWindow.style.top = top;
                        weatherWindow.style.left = `calc(33.33% + (${gap}/3))`;
                        weatherWindow.style.width = `calc(33.33% - (${gap}/3) - (${gap}/3))`;
                        weatherWindow.style.height = `calc(100vh - ${top} - ${bottom})`;
                        
                        factWindow.style.top = top;
                        factWindow.style.left = `calc(66.66% + (${gap}/3))`;
                        factWindow.style.width = `calc(33.33% - ${gap} - (${gap}/3))`;
                        factWindow.style.height = `calc(100vh - ${top} - ${bottom})`;
                        break;
                }
            }

            // --- AlÄ±cÄ± (Receiver) Pencere SÃ¼rÃ¼kleme FonksiyonlarÄ± ---
            function setupDraggableWindows() {
                document.querySelectorAll('.draggable-window').forEach(makeDraggable);
            }
            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                const header = element.querySelector('.window-header');

                if (header) {
                    header.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                    document.querySelectorAll('.draggable-window').forEach(win => win.style.zIndex = 10);
                    element.style.zIndex = 20;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }

        }); // DOMContentLoaded sarmalayÄ±cÄ±sÄ±nÄ±n sonu
    </script>
</body>
</html>
