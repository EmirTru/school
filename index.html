<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarÄ±ca UÄŸur Okulu - GerÃ§ek ZamanlÄ± Duyuru ğŸ“¢</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Ana Font */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Yatay kaydÄ±rmayÄ± engelle */
            
            /* --- YENÄ° GÃ–RSEL EFEKT --- */
            /* CanlÄ± bir arka plan gradienti */
            background: linear-gradient(120deg, #1e3a8a 0%, #312e81 50%, #0c0a09 100%);
            background-size: 200% 200%;
            animation: backgroundGradient 15s ease infinite;
        }

        @keyframes backgroundGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- YENÄ° CAM EFEKTÄ° (Glassmorphism) KARTI --- */
        .glass-card {
            background: rgba(23, 37, 84, 0.4); /* YarÄ± saydam koyu mavi */
            backdrop-filter: blur(12px); /* Arka planÄ± bulanÄ±klaÅŸtÄ±r */
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.25rem; /* 20px */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Ä°nce beyaz Ã§erÃ§eve */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); /* YumuÅŸak gÃ¶lge */
        }
        
        #announcement-display-content {
            transition: all 0.3s ease;
            word-wrap: break-word;
        }

        /* --- Animasyon Keyframes --- */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }

        .announcement-pulse {
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px rgba(96, 165, 250, 0.7); } /* blue-400 */
            70% { box-shadow: 0 0 0 10px rgba(96, 165, 250, 0); }
            100% { box-shadow: 0 0 0 0px rgba(96, 165, 250, 0); }
        }

        .bell-animation {
            font-size: 8rem; /* Ã‡ok bÃ¼yÃ¼k zil */
            animation: bellRing 1.5s infinite ease-in-out;
            transform-origin: top center; /* Ãœstten sallanma */
            display: inline-block; /* sallanmasÄ± iÃ§in gerekli */
            text-shadow: 0 0 20px rgba(250, 204, 21, 0.7); /* Zile sarÄ± bir parlama ekle */
        }
        @keyframes bellRing {
            0% { transform: rotate(0deg); }
            15% { transform: rotate(15deg); }
            30% { transform: rotate(-15deg); }
            45% { transform: rotate(10deg); }
            60% { transform: rotate(-10deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 1. Rol SeÃ§im EkranÄ± (BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r) -->
    <div id="role-selection-screen" class="glass-card p-8 w-full max-w-sm text-center fade-in">
        <h1 class="text-3xl font-bold mb-6 text-white">DarÄ±ca UÄŸur Okulu ğŸ‡¹ğŸ‡·</h1>
        <p class="text-gray-300 mb-8 text-lg">Duyuru Sistemine HoÅŸ Geldiniz!</p>
        <div class="space-y-4">
            <button id="select-publisher" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
                ğŸ“£ YayÄ±ncÄ± (Duyuru GÃ¶nder)
            </button>
            <button id="select-receiver" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
                ğŸ§ AlÄ±cÄ± (Sadece Duyuru Al)
            </button>
        </div>
    </div>

    <!-- 2. Åifre EkranÄ± (Gizli) -->
    <div id="password-screen" class="glass-card p-8 w-full max-w-sm text-center hidden fade-in">
        <h1 class="text-2xl font-bold mb-6 text-white">YayÄ±ncÄ± GiriÅŸi</h1>
        <p class="text-gray-300 mb-4">Duyuru yayÄ±nlamak iÃ§in ÅŸifreyi girin.</p>
        <input id="password-input" type="password" class="w-full p-3 bg-gray-900/50 border border-gray-400/30 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 transform hover:scale-105">
            GiriÅŸ Yap
        </button>
        <p id="password-hint" class="text-gray-400 text-sm mt-4">Ä°pucu: ÅŸifre 1234</p>
        <p id="password-error" class="text-red-400 text-sm mt-2 hidden">HatalÄ± ÅŸifre!</p>
        <button id="back-to-roles" class="text-gray-300 hover:text-white text-sm mt-6">Geri</button>
    </div>


    <!-- 3. Ana Uygulama EkranÄ± (Gizli) -->
    <div id="main-app-screen" class="glass-card p-6 md:p-8 w-full max-w-lg hidden fade-in">
        <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-center mb-6 text-white">
            <!-- BaÅŸlÄ±k JS ile ayarlanacak -->
        </h1>

        <!-- Sadece YayÄ±ncÄ±nÄ±n GÃ¶receÄŸi Alan -->
        <div id="publisher-controls" class="hidden space-y-4">
            
            <!-- Duyuru BaÅŸlÄ±ÄŸÄ± -->
            <div>
                <label for="title-input" class="block text-sm font-medium text-gray-300 mb-2">Duyuru BaÅŸlÄ±ÄŸÄ±:</label>
                <input id="title-input" type="text" class="w-full p-3 bg-gray-900/50 border border-gray-400/30 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ã–rn: 29 Ekim TÃ¶ren ProvasÄ± ğŸ‡¹ğŸ‡·">
            </div>

            <!-- Ã–nem Derecesi -->
            <div>
                <label for="urgency-select" class="block text-sm font-medium text-gray-300 mb-2">Ã–nem Derecesi:</label>
                <select id="urgency-select" class="w-full p-3 bg-gray-900/50 border border-gray-400/30 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="normal" class="text-black">Normal</option>
                    <option value="onemli" class="text-black">Ã–nemli</option>
                    <option value="acil" class="text-black">ğŸš¨ ACÄ°L ğŸš¨</option>
                </select>
            </div>

            <!-- Kime -->
            <div>
                <label for="audience-select" class="block text-sm font-medium text-gray-300 mb-2">Kime:</label>
                <select id="audience-select" class="w-full p-3 bg-gray-900/50 border border-gray-400/30 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="tum-okul" class="text-black">TÃ¼m Okul</option>
                    <option value="ogrenciler" class="text-black">Ã–ÄŸrenciler</option>
                    <option value="ogretmenler" class="text-black">Ã–ÄŸretmenler</option>
                    <option value="veliler" class="text-black">Veliler</option>
                </select>
            </div>

            <!-- Duyuru DetayÄ± -->
            <div>
                <label for="announcement-input" class="block text-sm font-medium text-gray-300 mb-2">Duyuru DetayÄ±:</label>
                <textarea id="announcement-input" rows="4" class="w-full p-3 bg-gray-900/50 border border-gray-400/30 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Duyuru ile ilgili detaylarÄ± buraya yazÄ±n..."></textarea>
            </div>

            <!-- YENÄ°: Manuel Zil Animasyonu Checkbox'Ä± -->
            <div class="flex items-center">
                <input id="manual-bell-check" type="checkbox" class="h-4 w-4 rounded bg-gray-900/50 border-gray-400/30 text-blue-600 focus:ring-blue-500">
                <label for="manual-bell-check" class="ml-2 block text-sm text-gray-300">ğŸ”” Manuel Zil Animasyonu Ekle</label>
            </div>
            
            <!-- Kantin HÄ±zlÄ± ÅablonlarÄ± -->
            <div class="border-t border-gray-400/30 pt-4">
                 <label class="block text-sm font-medium text-gray-300 mb-2">Kantin HÄ±zlÄ± ÅablonlarÄ±:</label>
                 <div class="flex flex-wrap gap-2">
                    <button data-template="menu" class="template-btn bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ½ï¸ MenÃ¼
                    </button>
                    <button data-template="tost" class="template-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ‰ Tost GÃ¼nÃ¼
                    </button>
                    <button data-template="muzik" class="template-btn bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ¶ MÃ¼zik Ä°steÄŸi
                    </button>
                    <button data-template="kapanis" class="template-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition duration-300">
                        ğŸ”” KapanÄ±ÅŸ
                    </button>
                 </div>
            </div>

            <!-- YayÄ±nla Butonu -->
            <button id="publish-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration:300 ease-in-out transform hover:scale-105 mt-4" disabled>
                YayÄ±nla ğŸš€
            </button>

            <!-- AyÄ±rÄ±cÄ± -->
            <hr class="border-gray-400/30 my-6">
        </div>
        
        <!-- Son Duyuru GÃ¶rÃ¼ntÃ¼leme AlanÄ± (Herkes gÃ¶rÃ¼r) -->
        <div>
            <h2 class="text-xl font-semibold mb-3 text-gray-200">Son Gelen Duyuru:</h2>
            
            <!-- GÃ¶rsel Efekt AlanÄ± (Zil vb.) -->
            <div id="visual-effect-area" class="text-center mb-4 min-h-[50px] flex items-center justify-center">
                <!-- Zil animasyonu buraya gelecek -->
            </div>
            
            <!-- Duyurunun kendisi (iÃ§erik) -->
            <div id="announcement-display-content" class="w-full min-h-[100px] p-4 bg-gray-900/50 rounded-lg border border-gray-400/30">
                <p id="loading-text" class="text-gray-400 italic">Duyurular bekleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase modÃ¼llerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase hata ayÄ±klama loglarÄ±nÄ± aÃ§
        setLogLevel('Debug');

        // --- DOM Elementleri ---
        const roleScreen = document.getElementById('role-selection-screen');
        const selectPublisherBtn = document.getElementById('select-publisher');
        const selectReceiverBtn = document.getElementById('select-receiver');
        
        const passwordScreen = document.getElementById('password-screen');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const passwordError = document.getElementById('password-error');
        const backToRolesBtn = document.getElementById('back-to-roles');

        const mainAppScreen = document.getElementById('main-app-screen');
        const appTitle = document.getElementById('app-title');
        const publisherControls = document.getElementById('publisher-controls');
        
        // YayÄ±ncÄ± alanlarÄ±
        const titleInput = document.getElementById('title-input');
        const urgencySelect = document.getElementById('urgency-select');
        const audienceSelect = document.getElementById('audience-select');
        const inputArea = document.getElementById('announcement-input');
        const manualBellCheck = document.getElementById('manual-bell-check'); // YENÄ°
        
        const publishButton = document.getElementById('publish-button');
        const displayContent = document.getElementById('announcement-display-content'); // Ä°Ã§erik alanÄ±
        const loadingText = document.getElementById('loading-text');
        const visualEffectArea = document.getElementById('visual-effect-area');


        // --- YENÄ° VE TAM FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeQsh4Tp-YbLG8BcgoMDKXi5gJ0rBZ5pI",
            authDomain: "emirokuldeneme.firebaseapp.com",
            projectId: "emirokuldeneme",
            storageBucket: "emirokuldeneme.firebasestorage.app",
            messagingSenderId: "821824749207",
            appId: "1:821824749207:web:164b0ea4c79bf9636f33d2"
        };
        // -------------------------------------------

        // --- Firebase DeÄŸiÅŸkenleri ---
        let db;
        let auth;
        let userId;
        const appId = firebaseConfig.projectId || 'genel-duyuru-odasi';
        const broadcastDocRef = () => doc(db, 'artifacts', appId, 'public/data', 'announcements', 'latest');

        // --- Rol SeÃ§im OlaylarÄ± ---
        selectPublisherBtn.addEventListener('click', () => {
            roleScreen.classList.add('hidden');
            passwordScreen.classList.remove('hidden'); // Åifre ekranÄ±nÄ± gÃ¶ster
            passwordInput.focus();
        });

        selectReceiverBtn.addEventListener('click', () => {
            startAppAs('receiver'); // AlÄ±cÄ± doÄŸrudan baÅŸlar
        });

        backToRolesBtn.addEventListener('click', () => {
            passwordScreen.classList.add('hidden');
            roleScreen.classList.remove('hidden');
            passwordError.classList.add('hidden');
            passwordInput.value = "";
        });

        // --- ÅÄ°FRE KONTROLÃœ ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === "1234") {
                passwordScreen.classList.add('hidden');
                passwordInput.value = "";
                passwordError.classList.add('hidden');
                startAppAs('publisher'); // Åifre doÄŸru, yayÄ±ncÄ± olarak baÅŸlat
            } else {
                // Hata gÃ¶ster ve salla
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('shake');
                setTimeout(() => {
                    passwordInput.classList.remove('shake');
                    passwordError.classList.add('hidden');
                }, 1000);
            }
        });
        // Enter tuÅŸu ile giriÅŸ
        passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loginButton.click();
        });


        // --- Uygulama BaÅŸlatma Fonksiyonu ---
        function startAppAs(role) {
            roleScreen.classList.add('hidden'); 
            mainAppScreen.classList.remove('hidden');

            if (role === 'publisher') {
                appTitle.innerHTML = `ğŸ“¢ YayÄ±ncÄ± Paneli <span class="text-blue-300 block text-lg">(DarÄ±ca UÄŸur Okulu)</span>`;
                publisherControls.classList.remove('hidden'); 
            } else {
                appTitle.innerHTML = `ğŸ§ Duyuru AlÄ±cÄ±sÄ± <span class="text-blue-300 block text-lg">(DarÄ±ca UÄŸur Okulu)</span>`;
            }

            initializeAppAndAuth();
        }

        // --- Firebase BaÅŸlatma ve Kimlik DoÄŸrulama ---
        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuth();
            } catch (error) {
                console.error("Firebase baÅŸlatma hatasÄ±:", error);
                displayContent.innerHTML = `<p class="text-red-400">Hata: Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. ${error.message}</p>`;
                if(loadingText) loadingText.remove();
            }
        }

        async function setupAuth() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Kimlik doÄŸrulandÄ± (Anonim). KullanÄ±cÄ± ID:", userId);
                        setupRealtimeListener(); // Dinleyiciyi baÅŸlat

                        if (publisherControls.classList.contains('hidden') === false) {
                            publishButton.addEventListener('click', publishAnnouncement);
                            publishButton.disabled = false;
                            setupTemplateButtons(); // Åablon butonlarÄ±nÄ± ayarla
                        }
                    } else {
                        console.log("KullanÄ±cÄ± oturumu kapattÄ±.");
                        if(publishButton) publishButton.disabled = true;
                    }
                });
            } catch (error) {
                console.error("Kimlik doÄŸrulama hatasÄ±:", error);
                displayContent.innerHTML = `<p class="text-red-400">Hata: Kimlik doÄŸrulanamadÄ±. ${error.message}</p>`;
                if(loadingText) loadingText.remove();
            }
        }
        
        // --- Kantin ÅablonlarÄ±nÄ± Ayarla ---
        function setupTemplateButtons() {
            document.querySelectorAll('.template-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const template = e.target.dataset.template;
                    
                    // Formu temizle
                    urgencySelect.value = 'normal';
                    audienceSelect.value = 'ogrenciler'; 
                    manualBellCheck.checked = false;
                    
                    switch(template) {
                        case 'menu':
                            titleInput.value = "BugÃ¼nÃ¼n MenÃ¼sÃ¼ ğŸ½ï¸";
                            inputArea.value = "Afiyet olsun! BugÃ¼nkÃ¼ yemek listesi:\n1. Mercimek Ã‡orbasÄ±\n2. Ana Yemek (Ã–rn: Tavuk Sote)\n3. Pilav/Makarna\n4. Salata/TatlÄ±";
                            break;
                        case 'tost':
                            titleInput.value = "ğŸ‰ SÃ¼rpriz Tost GÃ¼nÃ¼! ğŸ‰";
                            inputArea.value = "BugÃ¼n kantinde sÄ±cak ve lezzetli tostlar sizleri bekliyor! KaÃ§Ä±rmayÄ±n!";
                            urgencySelect.value = 'onemli';
                            break;
                        case 'muzik':
                            titleInput.value = "ğŸ¶ MÃ¼zik Ä°steÄŸi ğŸ¶";
                            inputArea.value = "Ã–ÄŸle arasÄ±nda kantinde Ã§almasÄ±nÄ± istediÄŸiniz ÅŸarkÄ±larÄ± duyuru panosuna (veya Ã¶zel bir listeye) not bÄ±rakabilirsiniz. En Ã§ok istenenler Ã§alacak!";
                            break;
                        case 'kapanis':
                            titleInput.value = "ğŸ”” Kantin KapanÄ±yor ğŸ””";
                            inputArea.value = "Kantinimiz 10 dakika iÃ§inde kapanacaktÄ±r. LÃ¼tfen ihtiyaÃ§larÄ±nÄ±zÄ± giderin. YarÄ±n gÃ¶rÃ¼ÅŸmek Ã¼zere!";
                            urgencySelect.value = 'acil';
                            manualBellCheck.checked = true; // KapanÄ±ÅŸ zili otomatk seÃ§ilsin
                            break;
                    }
                    titleInput.focus();
                });
            });
        }

        // --- Ã–nem Derecesine GÃ¶re Stil Veren YardÄ±mcÄ± Fonksiyon ---
        function getUrgencyStyles(urgency) {
            switch (urgency) {
                case 'acil':
                    return 'bg-red-900/70 border-red-500';
                case 'onemli':
                    return 'bg-yellow-900/70 border-yellow-500';
                default:
                    return 'bg-gray-900/50 border-gray-400/30';
            }
        }
        function getUrgencyLabel(urgency) {
            switch (urgency) {
                case 'acil':
                    return 'ğŸš¨ ACÄ°L';
                case 'onemli':
                    return 'Ã–NEMLÄ°';
                default:
                    return 'Normal';
            }
        }

        // --- Firestore'daki deÄŸiÅŸiklikleri gerÃ§ek zamanlÄ± dinle ---
        let lastAnnouncementTimestamp = 0; 
        function setupRealtimeListener() {
            console.log("Duyuru dinleyicisi kuruluyor...");
            const docRef = broadcastDocRef();
            
            onSnapshot(docRef, (doc) => {
                if (loadingText) {
                    loadingText.style.display = 'none'; // YÃ¼kleniyor yazÄ±sÄ±nÄ± gizle
                }
                
                if (doc.exists()) {
                    const data = doc.data();
                    const currentTimestamp = new Date(data.timestamp).getTime();

                    // Sadece yeni duyurular iÃ§in animasyon tetikle
                    if (currentTimestamp > lastAnnouncementTimestamp) {
                        displayContent.classList.remove('announcement-pulse'); 
                        void displayContent.offsetWidth; // Reflow
                        displayContent.classList.add('announcement-pulse'); 
                        lastAnnouncementTimestamp = currentTimestamp;
                        
                        // --- YENÄ° ANÄ°MASYON MANTIÄI ---
                        visualEffectArea.innerHTML = ''; // Ã–nceki efektleri temizle
                        // 1. Acil ise VEYA manuel zil seÃ§ildiyse zili Ã§al
                        if (data.urgency === 'acil' || data.playBell === true) {
                            visualEffectArea.innerHTML = '<span class="bell-animation">ğŸ””</span>';
                        }
                        
                        mainAppScreen.scrollTo({ top: 0, behavior: 'smooth' });
                    }

                    // Zengin Duyuru FormatÄ±
                    const urgencyClass = getUrgencyStyles(data.urgency);
                    const urgencyLabel = getUrgencyLabel(data.urgency);

                    displayContent.innerHTML = `
                        <div class="p-4 rounded-lg ${urgencyClass} border fade-in">
                            <!-- Ãœst Bilgi SatÄ±rÄ± -->
                            <div class="flex justify-between items-center mb-2">
                                <span class="px-3 py-1 text-sm font-semibold rounded-full ${data.urgency === 'acil' ? 'bg-red-200 text-red-900' : (data.urgency === 'onemli' ? 'bg-yellow-200 text-yellow-900' : 'bg-gray-200 text-gray-900')}">
                                    ${urgencyLabel}
                                </span>
                                <span class="text-sm text-gray-300 font-medium">Kime: ${data.audience}</span>
                            </div>
                            
                            <!-- BaÅŸlÄ±k (TÃ¼rk bayraÄŸÄ± kontrolÃ¼ eklendi) -->
                            <h3 class="text-2xl font-bold text-white mb-2">
                                ${data.title.replace('ğŸ‡¹ğŸ‡·', '<span class="inline-block ml-2 text-3xl">ğŸ‡¹ğŸ‡·</span>')}
                            </h3>
                            
                            <!-- Detay (BoÅŸluklarÄ± korumak iÃ§in whitespace-pre-wrap) -->
                            <p class="text-gray-100 text-lg whitespace-pre-wrap">${data.text}</p>
                            
                            <!-- Zaman DamgasÄ± -->
                            <p class="text-gray-400 text-xs mt-4 text-right">YayÄ±nlanma: ${data.timestamp}</p>
                        </div>
                    `;
                    
                } else {
                    displayContent.innerHTML = `<p class="text-gray-400 italic">HenÃ¼z bir duyuru yayÄ±nlanmadÄ±.</p>`;
                    visualEffectArea.innerHTML = ''; // Duyuru yoksa efekti de temizle
                }
            }, (error) => {
                console.error("Veri dinleme hatasÄ± (onSnapshot):", error);
                displayContent.innerHTML = `<p class="text-red-400">Hata: Veri alÄ±namadÄ±. ${error.message}</p>`;
            });
        }

        // --- Yeni duyuru yayÄ±nla (GÃœNCELLENDÄ°) ---
        async function publishAnnouncement() {
            const title = titleInput.value.trim();
            const text = inputArea.value.trim();
            const urgency = urgencySelect.value;
            const audience = audienceSelect.value;
            const playBell = manualBellCheck.checked; // YENÄ°

            if (!title || !text) {
                console.warn("BaÅŸlÄ±k ve Detay alanlarÄ± boÅŸ bÄ±rakÄ±lamaz.");
                // Hata uyarÄ±sÄ±
                titleInput.classList.add('shake');
                inputArea.classList.add('shake');
                setTimeout(() => {
                    titleInput.classList.remove('shake');
                    inputArea.classList.remove('shake');
                }, 500);
                return;
            }

            publishButton.disabled = true;
            publishButton.textContent = "YayÄ±nlanÄ±yor...";

            try {
                await setDoc(broadcastDocRef(), {
                    title: title,
                    text: text,
                    urgency: urgency,
                    audience: audience,
                    playBell: playBell, // YENÄ°: Zil durumunu kaydet
                    timestamp: new Date().toLocaleString('tr-TR'),
                    publishedBy: userId 
                });

                // Formu temizle
                titleInput.value = "";
                inputArea.value = "";
                urgencySelect.value = "normal";
                audienceSelect.value = "tum-okul";
                manualBellCheck.checked = false; // Checkbox'Ä± temizle
                
                console.log("Yeni duyuru baÅŸarÄ±yla yayÄ±nlandÄ±!");

            } catch (error) {
                console.error("Duyuru yayÄ±nlama hatasÄ± (setDoc):", error);
                displayContent.innerHTML += `<p class="text-red-400 text-sm mt-2">Hata: Duyuru gÃ¶nderilemedi.</p>`;
            } finally {
                publishButton.disabled = false;
                publishButton.textContent = "Duyuruyu YayÄ±nla ğŸš€";
            }
        }

    </script>
</body>
</html>
